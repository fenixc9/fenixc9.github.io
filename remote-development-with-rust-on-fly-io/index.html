<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Microsoft YaHei:300,300italic,400,400italic,700,700italic|Noto Serif SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"fenixc9.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":10,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":false,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":{"gitalk":{"order":-2}}},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"manual"},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="这篇酷熊聊了如何用Rust使用多种先进的工具构建高性能远程开发环境。">
<meta property="og:type" content="article">
<meta property="og:title" content="【译】在 fly.io 上使用 Rust 进行远程开发">
<meta property="og:url" content="https://fenixc9.github.io/remote-development-with-rust-on-fly-io/index.html">
<meta property="og:site_name" content="ByteDrift">
<meta property="og:description" content="这篇酷熊聊了如何用Rust使用多种先进的工具构建高性能远程开发环境。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://fenixc9.github.io/remote-development-with-rust-on-fly-io/1.avif">
<meta property="og:image" content="https://fenixc9.github.io/remote-development-with-rust-on-fly-io/2.avif">
<meta property="og:image" content="https://fenixc9.github.io/remote-development-with-rust-on-fly-io/3.avif">
<meta property="og:image" content="https://fenixc9.github.io/remote-development-with-rust-on-fly-io/4.avif">
<meta property="og:image" content="https://fenixc9.github.io/remote-development-with-rust-on-fly-io/6.avif">
<meta property="og:image" content="https://fenixc9.github.io/remote-development-with-rust-on-fly-io/7.avif">
<meta property="article:published_time" content="2023-03-05T03:48:36.000Z">
<meta property="article:modified_time" content="2025-04-05T03:45:29.189Z">
<meta property="article:author" content="fenix">
<meta property="article:tag" content="Rust">
<meta property="article:tag" content="eBPF">
<meta property="article:tag" content="翻译">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://fenixc9.github.io/remote-development-with-rust-on-fly-io/1.avif">

<link rel="canonical" href="https://fenixc9.github.io/remote-development-with-rust-on-fly-io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>【译】在 fly.io 上使用 Rust 进行远程开发 | ByteDrift</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">ByteDrift</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fenixc9.github.io/remote-development-with-rust-on-fly-io/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/a.jpeg">
      <meta itemprop="name" content="fenix">
      <meta itemprop="description" content="程序员，无可救药的理想主义者">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ByteDrift">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          【译】在 fly.io 上使用 Rust 进行远程开发
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-03-05 11:48:36" itemprop="dateCreated datePublished" datetime="2023-03-05T11:48:36+08:00">2023-03-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-04-05 11:45:29" itemprop="dateModified" datetime="2025-04-05T11:45:29+08:00">2025-04-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Rust/" itemprop="url" rel="index"><span itemprop="name">Rust</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
            <div class="post-description">这篇酷熊聊了如何用Rust使用多种先进的工具构建高性能远程开发环境。</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>原文： <a target="_blank" rel="noopener" href="https://fasterthanli.me/articles/remote-development-with-rust-on-fly-io">https://fasterthanli.me/articles/remote-development-with-rust-on-fly-io</a></p>
<p>披露：在撰写本文时，我受益于 fly.io“员工免费套餐”。我不会为“在合理范围内”托管在那里的副项目付费。这里讨论的项目符合这一条件。</p>
<h2 id="为什么您可能需要远程开发环境"><a href="#为什么您可能需要远程开发环境" class="headerlink" title="为什么您可能需要远程开发环境"></a>为什么您可能需要远程开发环境</h2><p>撇开这条<a target="_blank" rel="noopener" href="https://twitter.com/github/status/1537148707673497600">不幸的推文</a>带来很多克苏鲁之外的恐慌不谈，我们有很多理由想要一个远程开发环境。</p>
<p>例如，也许您唯一可用的计算机的性能不足以执行您想要执行的任务。如：构建很多很多 Rust 项目。像编译器，或者 rust-analyzer，或者你可能像我一样古怪，你独自维护着 7 个大型专有代码库，所以你的博客 slash 视频平台是你喜欢的方式。</p>
<p>因此，与其购买强劲 CPU（如 Threadripper，或更消费化的产品，如最新的 Ryzens），不如租用一台可以根据需要打开和关闭的大型云计算机。只为搞大事情。</p>
<pre><code>如果你需要一堆 CPU 直接在 Rust 项目本身上工作，顺便说一句，Rust 基金会有一个程序。
</code></pre>
<p>另一个很好的理由是你投资了另一个不兼容的品牌 CPU，比如 M1 或 M2（它会在哪里结束？），这是 arm64。但是您需要为 Linux x86_64 部署。</p>
<p>在这种情况下，您可以假装 macOS arm64 和 Linux x86_64 由于 都非常”unix”，而“足够接近”，并为基本上两个target维护您的代码库，为以后留下令人讨厌的惊喜，或者您可以在 VM 中工作。或者 x86_64 Docker 容器，在 macOS 上，它在 VM 中运行。</p>
<p>这很好，但它会让大多数笔记本电脑起飞。我不知道 Apple Silicon 的情况如何（有人给我发一个！）但我假设即使它是一场革命，在它上面模拟 x86 仍然不如实际的 x86 处理器快。我可能错了。我相信我很快就会知道的。</p>
<p>另一个很好的理由是，您可能正在管理一个开发团队，而不仅仅是您。你希望能够 1) 雇用来自世界各地的人，2) 雇用家里还没有一台笨拙电脑的人，3) 不必向他们运送一台笨拙的电脑（然后你必须得到回馈或赠予他们），4) 快速让他们入职，为他们提供一个一致的开发环境，让一切在第一次就可以正常工作。</p>
<p>我，我没有团队。好吧……我这样做：每次我发表文章时，都会有一大群人通过报告拼写错误、不准确等来弥补编辑的缺席。但是所有代码方面都只有我一个人。而且我有几台计算机可以胜任定期编译一公吨 Rust 的任务，就像我倾向于做的那样。他们都没有在桌面上运行 Linux，虽然我专门为 Linux 提供东西（包括我的日常工作和我的副业），但这不是 VM 无法解决的问题，而且我有很多这样的东西。</p>
<p>我的理由要简单得多，而且可能很愚蠢：在我写这篇文章时，外面的温度是 37 摄氏度（99 华氏度）。我的大型台式机不仅不是我可用的最环保的机器，而且还会散发出相当多的热量。这些热量还会累加。</p>
<p>此外，我也喜欢能够从不同的地方写作，所以这意味着要有两台电脑，并使用一台（笔记本电脑）远程连接到另一台（台式机），这使得能源+热量问题变得更糟，而且现在我们会遇到这样的麻烦 “当您通过 SSH 连接到在其上运行的 Linux VM 时，您如何设法使桌面保持清醒状态，但当它不在时使其迅速进入睡眠状态”。</p>
<pre><code>你知道你点击发布的那一刻有人会告诉你这并不难，如果你只是这样做（随后有两页的说明）
</code></pre>
<p>是的，我知道。仍然存在散热和电费账单的问题。</p>
<p>所以无论如何，因为 fly.io 在工作日付钱给我让他们的平台变得更好（更准确地说是 fly-proxy，所有 TCP 流量现在都经过的东西，除了 IPv6 专用网络，我最近在他们的网站上写过博客），我有一个员工折扣优惠。</p>
<p>这笔交易是我直接不为那里的计算付费。所以这里有一个重要的旧免责声明：<strong>我不需要为此支付任何费用。他们也在付钱给我，但为了其他东西。</strong> 这是周末阿莫斯。付钱让我写这篇文章的人是我的赞助人——所以作为fly.io的非付费客户，我会在那里给出我的诚实意见。</p>
<p>我们对免责声明部分满意吗？大家清楚了吗？    </p>
<pre><code>所以，你是一个托儿，暂时扮演“不是托儿”的角色，你找到了一种方法把 Rust 偷偷放进去，因为你情不自禁。
</code></pre>
<p>我的意思是，当然……但我只是觉得它很整洁？我会解释一堆关于它如何工作的东西，以及为什么它对我特别有效（即使我确实需要为此付费）。</p>
<h2 id="fly-io-到底是干什么用的"><a href="#fly-io-到底是干什么用的" class="headerlink" title="fly.io 到底是干什么用的"></a>fly.io 到底是干什么用的</h2><p>这部分可能会被误解为营销，但实际上我只是想让你们清楚我们正在合作的内容。我花了很长时间才真正理解 fly 是什么，即使在阅读了几次文档之后也是如此。在从内部破解它，以及后来的几个副项目（比如我的视频）之后，我想我明白了。</p>
<p>所以基本上 fly 让你做的是将你的代码推送到那里，然后让它在云中运行。</p>
<pre><code>啊，就像 Heroku。
</code></pre>
<p>有点像但也没有。Heroku 有整个 buildpacks 的东西，我想 fly 也以某种方式支持它，但我对那部分根本不感兴趣，所以我的理解还不足以回答这个问题。</p>
<p>我个人的看法是，我用任何东西构建了一个 Docker 镜像（目前只有 x86_64），推动它运行（所以他们有自己的镜像注册表），然后它在云中运行。</p>
<pre><code>啊，就像 Google Cloud Run 或任何与 AWS 等效的东西。
</code></pre>
<p>同样，有点像但也不是，因为它实际上并不在 Docker 中运行。它在<code>Firecracker microVM</code>中运行。这是一个真正的VM，因此您没有容器通常的限制。</p>
<pre><code>例如？
</code></pre>
<p>让我们稍后再谈。</p>
<p>首先让我向您展示如何在那里部署一个东西。我们的东西将是 Rust，因为我的博客我的规则，一如既往。</p>
<p>所以，我能想到的最简单的 HTTP 服务器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cargo new hello-axum</span></span><br><span class="line">     Created binary (application) `hello-axum` package</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> hello-axum</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cargo add tokio +full</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cargo add axum</span></span><br></pre></td></tr></table></figure>

<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in `hello-axum/src/main.rs`</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> axum::&#123;response::IntoResponse, routing::get, Router, Server&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[tokio::main]</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">app</span> = Router::<span class="title function_ invoke__">new</span>().<span class="title function_ invoke__">route</span>(<span class="string">&quot;/&quot;</span>, <span class="title function_ invoke__">get</span>(index));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">addr</span> = <span class="string">&quot;[::]:8080&quot;</span>.<span class="title function_ invoke__">parse</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Listening on http://&#123;addr&#125;&quot;</span>);</span><br><span class="line">    Server::<span class="title function_ invoke__">bind</span>(&amp;addr)</span><br><span class="line">        .<span class="title function_ invoke__">serve</span>(app.<span class="title function_ invoke__">into_make_service</span>())</span><br><span class="line">        .<span class="keyword">await</span></span><br><span class="line">        .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">index</span>() <span class="punctuation">-&gt;</span> <span class="keyword">impl</span> <span class="title class_">IntoResponse</span> &#123;</span><br><span class="line">    <span class="string">&quot;hello from axum\n&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它有效吗？</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ cargo run</span><br><span class="line">   Compiling cfg-<span class="keyword">if</span> v1.<span class="number">0.0</span></span><br><span class="line">   Compiling pin-project-lite v0.<span class="number">2.9</span></span><br><span class="line">   Compiling bytes v1.<span class="number">1.0</span></span><br><span class="line">   Compiling itoa v1.<span class="number">0.2</span></span><br><span class="line">   Compiling once_cell v1.<span class="number">12.0</span></span><br><span class="line">   Compiling smallvec v1.<span class="number">8.0</span></span><br><span class="line">   Compiling scopeguard v1.<span class="number">1.0</span></span><br><span class="line">   Compiling fnv v1.<span class="number">0.7</span></span><br><span class="line">   (cut)</span><br><span class="line">    Finished dev [unoptimized + debuginfo] <span class="title function_ invoke__">target</span>(s) <span class="keyword">in</span> <span class="number">2.55</span>s</span><br><span class="line">     Running `target/debug/hello-axum`</span><br><span class="line">Listening on http:<span class="comment">//[::]:8080</span></span><br></pre></td></tr></table></figure>

<p>然后，从另一个shell:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i <span class="number">0</span>:<span class="number">8080</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">content-<span class="keyword">type</span>: text/plain; charset=utf-<span class="number">8</span></span><br><span class="line">content-length: <span class="number">23</span></span><br><span class="line">date: Sat, <span class="number">18</span> Jun <span class="number">2022</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">47</span> GMT</span><br><span class="line"></span><br><span class="line">hello from axum</span><br></pre></td></tr></table></figure>

<p>好的，是时候将其构建为 Docker 镜像了：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># in `hello-axum/Dockerfile`</span></span><br><span class="line"><span class="comment"># syntax = docker/dockerfile:1.4</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> rust:<span class="number">1.61</span>.<span class="number">0</span>-slim-bullseye AS builder</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> --mount=<span class="built_in">type</span>=cache,target=/app/target \</span></span><br><span class="line"><span class="language-bash">		--mount=<span class="built_in">type</span>=cache,target=/usr/local/cargo/registry \</span></span><br><span class="line"><span class="language-bash">		--mount=<span class="built_in">type</span>=cache,target=/usr/local/cargo/git \</span></span><br><span class="line"><span class="language-bash">		--mount=<span class="built_in">type</span>=cache,target=/usr/local/rustup \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">set</span> -eux; \</span></span><br><span class="line"><span class="language-bash">		rustup install stable; \</span></span><br><span class="line"><span class="language-bash">	 	cargo build --release; \</span></span><br><span class="line"><span class="language-bash">		objcopy --compress-debug-sections target/release/hello-axum ./hello-axum</span></span><br><span class="line"></span><br><span class="line"><span class="comment">################################################################################</span></span><br><span class="line"><span class="keyword">FROM</span> debian:<span class="number">11.3</span>-slim</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">set</span> -eux; \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">export</span> DEBIAN_FRONTEND=noninteractive; \</span></span><br><span class="line"><span class="language-bash">	  apt update; \</span></span><br><span class="line"><span class="language-bash">		apt install --<span class="built_in">yes</span> --no-install-recommends bind9-dnsutils iputils-ping iproute2 curl ca-certificates htop; \</span></span><br><span class="line"><span class="language-bash">		apt clean autoclean; \</span></span><br><span class="line"><span class="language-bash">		apt autoremove --<span class="built_in">yes</span>; \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">rm</span> -rf /var/lib/&#123;apt,dpkg,cache,<span class="built_in">log</span>&#125;/; \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">echo</span> <span class="string">&quot;Installed base utils!&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/hello-axum ./hello-axum</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;./hello-axum&quot;</span>]</span></span><br><span class="line">````</span><br><span class="line"></span><br><span class="line">另外让我们/target从 Docker 上下文中排除，我们在那里不需要它：</span><br><span class="line">```dockerfile</span><br><span class="line"><span class="comment"># in `hello-axum/.dockerignore`</span></span><br><span class="line">/target</span><br></pre></td></tr></table></figure>
<p>还要确保你启用了 docker buildkit，这就是你现在 99% 的时间想要的，它支持所有好的东西。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t hello-axum .</span><br><span class="line">[+] Building 2.6s (6/13)</span><br><span class="line"> =&gt; [internal] load build definition from Dockerfile 0.0s</span><br><span class="line"> =&gt; =&gt; transferring dockerfile: 990B 0.0s</span><br><span class="line"> =&gt; [internal] load .dockerignore 0.0s</span><br><span class="line"> =&gt; =&gt; transferring context: 79B0.0s</span><br><span class="line"> =&gt; [internal] load metadata for docker.io/library/debian:11.3-slim 1.5s</span><br><span class="line"> =&gt; [internal] load metadata for docker.io/library/rust:1.61.0-slim-bullseye </span><br><span class="line">(cut)</span><br><span class="line"> =&gt; [stage-1 4/4] COPY --from=builder /app/hello-axum ./hello-axum </span><br><span class="line"> =&gt; exporting to image </span><br><span class="line"> =&gt; =&gt; exporting layers </span><br><span class="line"> =&gt; =&gt; writing image sha256:a6ae1acc11eb094218c1abb4da319a4e53ee93844d98d94c912698d75e2136e0 </span><br><span class="line"> =&gt; =&gt; naming to docker.io/library/hello-axum </span><br></pre></td></tr></table></figure>


<p>上面的 Dockerfile 中有几个巧妙的技巧：工具链、依赖项和文件夹target被缓存，它压缩调试符号（它们不存在，因为我忘了告诉你[profile.release] debug &#x3D; “1”在其中做Cargo.toml什么），它使用单独的阶段。</p>
<p>无论如何，生成的图像对我来说是 152MB，不是很好，也不是很糟糕，可能可以使用无容器或基于 Alpine 之类的东西，但这会带来其他权衡，这不是 Docker 教程，让我们继续。</p>
<p>重点是，它有效：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker run --detach --<span class="built_in">rm</span> --name hello-axum --publish 8080:8080 hello-axum</span></span><br><span class="line">78dde4d1e52dfc199e6ebdeda1b65192ba534cef6d5ea8ba169106e348eb4749</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl 0:8080</span></span><br><span class="line">hello from axum</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker <span class="built_in">kill</span> hello-axum</span></span><br><span class="line">hello-axum</span><br></pre></td></tr></table></figure>

<p>也就是说，如果您记得使用 Ctrl-C 终止其他进程。否则无法绑定到 8080 端口。</p>
<p>是时候用它部署fly了。我会跳过注册，你需要 安装 flyctl，用你的 fly 帐户登录，等等等等让我们创建一个应用程序：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">fly apps create</span></span><br><span class="line">? App Name: hello-axum</span><br><span class="line">? Select Organization: Amos Wenger (personal)</span><br><span class="line">New app created: hello-axum</span><br></pre></td></tr></table></figure>

<p>保存我们自动生成的配置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">fly config save -a hello-axum</span></span><br><span class="line">Wrote config file fly.toml</span><br></pre></td></tr></table></figure>

<p>这给了我们这个：</p>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># in `hello-axum/fly.toml`</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># fly.toml file generated for hello-axum on 2022-06-18T16:02:28Z</span></span><br><span class="line"></span><br><span class="line"><span class="attr">app</span> = <span class="string">&quot;hello-axum&quot;</span></span><br><span class="line"><span class="attr">kill_signal</span> = <span class="string">&quot;SIGINT&quot;</span></span><br><span class="line"><span class="attr">kill_timeout</span> = <span class="number">5</span></span><br><span class="line"><span class="attr">processes</span> = []</span><br><span class="line"></span><br><span class="line"><span class="section">[env]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[experimental]</span></span><br><span class="line">  <span class="attr">allowed_public_ports</span> = []</span><br><span class="line">  <span class="attr">auto_rollback</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="section">[[services]]</span></span><br><span class="line">  <span class="attr">http_checks</span> = []</span><br><span class="line">  <span class="attr">internal_port</span> = <span class="number">8080</span></span><br><span class="line">  <span class="attr">processes</span> = [<span class="string">&quot;app&quot;</span>]</span><br><span class="line">  <span class="attr">protocol</span> = <span class="string">&quot;tcp&quot;</span></span><br><span class="line">  <span class="attr">script_checks</span> = []</span><br><span class="line">  <span class="section">[services.concurrency]</span></span><br><span class="line">    <span class="attr">hard_limit</span> = <span class="number">25</span></span><br><span class="line">    <span class="attr">soft_limit</span> = <span class="number">20</span></span><br><span class="line">    <span class="attr">type</span> = <span class="string">&quot;connections&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="section">[[services.ports]]</span></span><br><span class="line">    <span class="attr">force_https</span> = <span class="literal">true</span></span><br><span class="line">    <span class="attr">handlers</span> = [<span class="string">&quot;http&quot;</span>]</span><br><span class="line">    <span class="attr">port</span> = <span class="number">80</span></span><br><span class="line"></span><br><span class="line">  <span class="section">[[services.ports]]</span></span><br><span class="line">    <span class="attr">handlers</span> = [<span class="string">&quot;tls&quot;</span>, <span class="string">&quot;http&quot;</span>]</span><br><span class="line">    <span class="attr">port</span> = <span class="number">443</span></span><br><span class="line"></span><br><span class="line">  <span class="section">[[services.tcp_checks]]</span></span><br><span class="line">    <span class="attr">grace_period</span> = <span class="string">&quot;1s&quot;</span></span><br><span class="line">    <span class="attr">interval</span> = <span class="string">&quot;15s&quot;</span></span><br><span class="line">    <span class="attr">restart_limit</span> = <span class="number">0</span></span><br><span class="line">    <span class="attr">timeout</span> = <span class="string">&quot;2s&quot;</span></span><br></pre></td></tr></table></figure>

<p>这些是默认值，把它们写下来很好。我确实想在端口 80 和 443 上公开内容，这些似乎是玩具应用程序的合理限制，我确实想自动将端口 80 重定向到 443，并且我的内部端口已经是 8080，唯一缺少的是要推送的镜像，因此，添加一个新部分：</p>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[build]</span></span><br><span class="line"><span class="attr">image</span> = <span class="string">&quot;hello-axum&quot;</span></span><br></pre></td></tr></table></figure>
<p>我们开始了：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">fly deploy</span></span><br><span class="line">==&gt; Verifying app config</span><br><span class="line"><span class="meta prompt_">--&gt; </span><span class="language-bash">Verified app config</span></span><br><span class="line">==&gt; Building image</span><br><span class="line">Searching for image &#x27;hello-axum&#x27; locally...</span><br><span class="line">image found: sha256:3f93ceb9158f5e123253060d58d607f7c2a7e2f93797b49b4edbbbcc8e1b3840</span><br><span class="line">==&gt; Pushing image to fly</span><br><span class="line">The push refers to repository [registry.fly.io/hello-axum]</span><br><span class="line">02f75279051e: Pushed </span><br><span class="line">4e38e245312b: Pushed </span><br><span class="line">85ade8c6ca76: Pushed </span><br><span class="line">ad6562704f37: Pushed </span><br><span class="line">deployment-1655568332: digest: sha256:1ddfda6a6d8d84d804602653501db1c9720677b6e04e31008d3256c53ec09723 size: 1159</span><br><span class="line"><span class="meta prompt_">--&gt; </span><span class="language-bash">Pushing image <span class="keyword">done</span></span></span><br><span class="line">==&gt; Creating release</span><br><span class="line"><span class="meta prompt_">--&gt; </span><span class="language-bash">release v2 created</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">--&gt; </span><span class="language-bash">You can detach the terminal anytime without stopping the deployment</span></span><br><span class="line">==&gt; Monitoring deployment</span><br><span class="line"></span><br><span class="line"> 1 desired, 1 placed, 1 healthy, 0 unhealthy [health checks: 1 total, 1 passing]</span><br><span class="line"><span class="meta prompt_">--&gt; </span><span class="language-bash">v0 deployed successfully</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>因为镜像在本地可用，所以它只是将其推送到 fly docker镜像仓库（还有一个我从未使用过的远程构建器功能）。</p>
<p>然后它为我们创建了一个应用程序实例……某处？最终分配给了一个worker，并且……感觉像是永恒但几乎肯定不到一分钟，我们的应用程序启动了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl https://hello-axum.fly.dev -i</span></span><br><span class="line">HTTP/2 200 </span><br><span class="line">content-type: text/plain; charset=utf-8</span><br><span class="line">content-length: 16</span><br><span class="line">date: Sat, 18 Jun 2022 16:07:39 GMT</span><br><span class="line">server: Fly/09a15cede3 (2022-06-17)</span><br><span class="line">via: 2 fly.io</span><br><span class="line">fly-request-id: 01G5VS3SPBQ4XY4M7VZXTG8KBJ-cdg</span><br><span class="line"></span><br><span class="line">hello from axum</span><br></pre></td></tr></table></figure>

<p>我们可以在这里看到一些新的标题！它还使用 http&#x2F;2，您可以从server标头中看出我昨天已部署到生产环境。</p>
<p>那里还有很多其他很酷的东西，比如内置指标，但这些并不是真正相关的。还有一个完整的网络用户界面，显示是的，我们确实有一个应用程序在运行，显示一些图表，甚至是实时流式传输的日志等。但是以这种格式谈论 CLI 更容易，所以，日志：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">fly logs</span></span><br><span class="line">2022-06-18T16:05:53Z runner[fdca430e] cdg [info]Starting instance</span><br><span class="line">2022-06-18T16:05:53Z runner[fdca430e] cdg [info]Configuring virtual machine</span><br><span class="line">2022-06-18T16:05:53Z runner[fdca430e] cdg [info]Pulling container image</span><br><span class="line">2022-06-18T16:05:58Z runner[fdca430e] cdg [info]Unpacking image</span><br><span class="line">2022-06-18T16:05:59Z runner[fdca430e] cdg [info]Preparing kernel init</span><br><span class="line">2022-06-18T16:05:59Z runner[fdca430e] cdg [info]Configuring firecracker</span><br><span class="line">2022-06-18T16:06:00Z runner[fdca430e] cdg [info]Starting virtual machine</span><br><span class="line">2022-06-18T16:06:00Z app[fdca430e] cdg [info][    0.026893] PCI: Fatal: No config space access function found</span><br><span class="line">2022-06-18T16:06:00Z app[fdca430e] cdg [info]Starting init (commit: e21acb3)...</span><br><span class="line">2022-06-18T16:06:00Z app[fdca430e] cdg [info]Preparing to run: `./hello-axum` as root</span><br><span class="line">2022-06-18T16:06:00Z app[fdca430e] cdg [info]2022/06/18 16:06:00 listening on [fdaa:0:446c:a7b:ae02:fdca:430e:2]:22 (DNS: [fdaa::3]:53)</span><br><span class="line">2022-06-18T16:06:00Z app[fdca430e] cdg [info]Listening on http://[::]:8080</span><br></pre></td></tr></table></figure>

<p>我不知道消息是什么PCI意思，不要问我。init是 fly 的自定义 init 程序，它也是全 Rust，这是它的旧快照，我们可以看到我们的应用程序正在运行。</p>
<p>我们甚至知道它运行的位置（cdg &#x3D; 巴黎戴高乐机场），离我住的地方最近的区域。</p>
<p>还有许多其他有用的 CLI 命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">fly status</span></span><br><span class="line">App</span><br><span class="line">  Name     = hello-axum          </span><br><span class="line">  Owner    = personal            </span><br><span class="line">  Version  = 0                   </span><br><span class="line">  Status   = running             </span><br><span class="line">  Hostname = hello-axum.fly.dev  </span><br><span class="line"></span><br><span class="line">Deployment Status</span><br><span class="line">  ID          = 70edc42a-9bac-0b2a-803c-c0cec866929a         </span><br><span class="line">  Version     = v0                                           </span><br><span class="line">  Status      = successful                                   </span><br><span class="line">  Description = Deployment completed successfully            </span><br><span class="line">  Instances   = 1 desired, 1 placed, 1 healthy, 0 unhealthy  </span><br><span class="line"></span><br><span class="line">Instances</span><br><span class="line">ID              PROCESS VERSION REGION  DESIRED STATUS  HEALTH CHECKS           RESTARTS        CREATED   </span><br><span class="line">fdca430e        app     0       cdg     run     running 1 total, 1 passing      0               6m50s ago</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">fly vm status fdca430e</span></span><br><span class="line">Instance</span><br><span class="line">  ID            = fdca430e            </span><br><span class="line">  Process       =                     </span><br><span class="line">  Version       = 0                   </span><br><span class="line">  Region        = cdg                 </span><br><span class="line">  Desired       = run                 </span><br><span class="line">  Status        = running             </span><br><span class="line">  Health Checks = 1 total, 1 passing  </span><br><span class="line">  Restarts      = 0                   </span><br><span class="line">  Created       = 7m10s ago           </span><br><span class="line"></span><br><span class="line">Recent Events</span><br><span class="line">TIMESTAMP            TYPE       MESSAGE                 </span><br><span class="line">2022-06-18T16:05:52Z Received   Task received by client </span><br><span class="line">2022-06-18T16:05:52Z Task Setup Building Task Directory </span><br><span class="line">2022-06-18T16:06:00Z Started    Task started by client  </span><br><span class="line"></span><br><span class="line">Checks</span><br><span class="line">ID                               SERVICE  STATE   OUTPUT                               </span><br><span class="line">3df2415693844068640885b45074b954 tcp-8080 passing TCP connect 172.19.2.2:8080: Success </span><br><span class="line"></span><br><span class="line">Recent Logs</span><br></pre></td></tr></table></figure>

<p>所以，是的，那是经典的飞翔！</p>
<p>我们fly regions set可以决定我们的应用程序应该在哪里运行，fly scale count我们可以更改正在运行的实例数，fly scale vm我们可以切换 VM 类型（现在非常简单），例如，这是我必须我用来做视频的:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ fly status</span><br><span class="line">App</span><br><span class="line">  Name     = tube          </span><br><span class="line">  Owner    = personal      </span><br><span class="line">  Version  = 164           </span><br><span class="line">  Status   = running       </span><br><span class="line">  Hostname = tube.fly.dev  </span><br><span class="line"></span><br><span class="line">Instances</span><br><span class="line">ID              PROCESS VERSION REGION  DESIRED STATUS  HEALTH CHECKS   RESTARTS    CREATED              </span><br><span class="line">c1f4d89e        app     164     sjc     run     running                 0           2022-06-14T22:02:22Z</span><br><span class="line">b74afb02        app     164     yyz     run     running                 0           2022-05-09T21:07:53Z</span><br><span class="line">8b5ca0c7        app     164     gru     run     running                 0           2022-05-09T21:07:15Z</span><br><span class="line">0b08b59c        app     164     ams     run     running                 0           2022-05-09T21:06:30Z</span><br><span class="line">6389589a        app     164     cdg     run     running                 0           2022-05-09T21:05:42Z</span><br><span class="line">ea94e5ef        app     164     nrt     run     running                 0           2022-05-09T21:03:21Z</span><br><span class="line">79ecda2b        app     164     iad     run     running                 1           2022-05-09T21:02:51Z</span><br><span class="line">26ea7a65        app     164     yyz     run     running                 0           2022-05-09T21:02:10Z</span><br><span class="line"></span><br><span class="line">$ fly scale show</span><br><span class="line">VM Resources for tube</span><br><span class="line">        VM Size: shared-cpu-1x</span><br><span class="line">      VM Memory: 512 MB</span><br><span class="line">          Count: 8</span><br><span class="line"> Max Per Region: Not set</span><br></pre></td></tr></table></figure>

<pre><code>试图让他们后悔他们一生的员工折扣，是吗？
</code></pre>
<p>嘿，规则是用来测试的。</p>
<p>哦，是的，还有volumes！因为实例被创建和销毁以及一些您不想丢失的数据，所以您将其保存在volumes中：  </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">fly volumes list</span></span><br><span class="line">ID                      STATE   NAME            SIZE    REGION  ZONE    ATTACHED VM     CREATED AT  </span><br><span class="line">vol_18l524y8j0er7zmp    created tubecache       40GB    ams     8aba    0b08b59c        1 month ago</span><br><span class="line">vol_18l524y8j5jr7zmp    created tubecache       40GB    yyz     d33c    26ea7a65        1 month ago</span><br><span class="line">vol_okgj54580lq4y2wz    created tubecache       40GB    iad     ddf7                    1 month ago</span><br><span class="line">vol_x915grnzw8krn70q    created tubecache       40GB    nrt     0e0f    ea94e5ef        1 month ago</span><br><span class="line">vol_ke628r68g3n4wmnp    created tubecache       40GB    sjc     c0a5    c1f4d89e        1 month ago</span><br><span class="line">vol_02gk9vwnej1v76wm    created tubecache       40GB    cdg     0e8c    6389589a        1 month ago</span><br><span class="line">vol_8zmjnv8em85vywgx    created tubecache       40GB    yyz     5e29    b74afb02        1 month ago</span><br><span class="line">vol_ypkl7vz8k5evqg60    created tubecache       40GB    iad     f6cb    79ecda2b        1 month ago</span><br><span class="line">vol_0nylzre12814qmkp    created tubecache       40GB    gru     2824    8b5ca0c7        1 month ago</span><br><span class="line">vol_52en7r1jpl9rk6yx    created tubecache       40GB    syd     039e                    1 month ago</span><br><span class="line">vol_w1q85vgn7jj4zdxe    created tubecache       40GB    lhr     ad0e                    1 month ago</span><br></pre></td></tr></table></figure>

<pre><code>你说你不想做营销？远程开发环境在哪里？
</code></pre>
<p>我开始了！所以回到我们的hello-axum应用程序，我们可以通过 SSH 进入它：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">fly ssh console</span></span><br><span class="line">Connecting to top1.nearest.of.hello-axum.internal... complete</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">whoami</span></span></span><br><span class="line">root</span><br><span class="line"><span class="meta prompt_"># </span></span><br></pre></td></tr></table></figure>
<p>这就是事情变得有趣的地方，因为这里你会开始注意到fly并没有运行一个docker容器。</p>
<p>让我们开始bash运行更多命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@fdca430e:/# cat /proc/cpuinfo | grep -i mhz</span><br><span class="line">cpu MHz         : 2799.998</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>所以我们有一个共享核心，这是默认设置。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">root@fdca430e:/<span class="comment"># uname -a</span></span></span><br><span class="line">Linux fdca430e 5.12.2 #1 SMP Thu Jun 2 14:26:49 UTC 2022 x86_64 GNU/Linux</span><br></pre></td></tr></table></figure>

<p>Linux 5.12.2，从 .. 2021 年 4 月开始，仍然相对较新。最近足够了，如果我们愿意的话，我们可以玩 io-uring。</p>
<pre><code>不不不不继续工作。
</code></pre>
<p>但是，是的，我们的 Docker 镜像不提供内核，只提供用户空间。内核是fly 给我们的任何东西。不过，我们有一个内核。稍后会派上用场。</p>
<p>现在，是时候回顾一下为什么“经典的 fly.io 应用程序”不能真正用作远程开发环境了。</p>
<p>首先，我们不能缩放到零。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">fly scale count 0</span></span><br><span class="line">Count changed to 0</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">fly status</span></span><br><span class="line">App</span><br><span class="line">  Name     = hello-axum          </span><br><span class="line">  Owner    = personal            </span><br><span class="line">  Version  = 1                   </span><br><span class="line">  Status   = dead                </span><br><span class="line">  Hostname = hello-axum.fly.dev  </span><br><span class="line"></span><br><span class="line">Instances</span><br><span class="line">ID      PROCESS VERSION REGION  DESIRED STATUS  HEALTH CHECKS   RESTARTS        CREATED</span><br></pre></td></tr></table></figure>

<p>好吧，我想你可以……但是正如你所看到的，应用程序的状态现在是“已死”。突然 fly-proxy不知道应用程序存在了。</p>
<p>所以如果我们尝试curl它：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -v https://hello-axum.fly.dev</span></span><br><span class="line">*   Trying 2a09:8280:1::1:4857:443...</span><br><span class="line">* TCP_NODELAY set</span><br><span class="line">* Connected to hello-axum.fly.dev (2a09:8280:1::1:4857) port 443 (#0)</span><br><span class="line">* ALPN, offering h2</span><br><span class="line">* ALPN, offering http/1.1</span><br><span class="line">* successfully set certificate verify locations:</span><br><span class="line">*   CAfile: /etc/ssl/certs/ca-certificates.crt</span><br><span class="line">  CApath: /etc/ssl/certs</span><br><span class="line">* TLSv1.3 (OUT), TLS handshake, Client hello (1):</span><br></pre></td></tr></table></figure>


<p>我们会被困在那里，最终：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* OpenSSL SSL_connect: Connection reset by peer in connection to hello-axum.fly.dev:443 </span><br><span class="line">* Closing connection 0</span><br><span class="line">curl: (35) OpenSSL SSL_connect: Connection reset by peer in connection to hello-axum.fly.dev:443</span><br></pre></td></tr></table></figure>

<p>那是因为fly-proxy正在等待另一个实例启动：如果您有一个发布策略，您的应用程序在部署之间暂时具有零个实例，则可能会发生这种情况。（您可能不想这样做，至少有一个实例可以避免停机）。</p>
<p>我们可以用 启动它fly scale，但它… 不快。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">time bash -c <span class="string">&#x27;fly scale count 1; while true; do curl https://hello-axum.fly.dev --max-time 1 &amp;&amp; exit 0 || echo &quot;still starting...&quot;; done&#x27;</span></span></span><br><span class="line">Count changed to 1</span><br><span class="line">curl: (28) Operation timed out after 1000 milliseconds with 0 out of 0 bytes received</span><br><span class="line">still starting...</span><br><span class="line">curl: (28) Operation timed out after 1001 milliseconds with 0 out of 0 bytes received</span><br><span class="line">still starting...</span><br><span class="line">curl: (28) Operation timed out after 1000 milliseconds with 0 out of 0 bytes received</span><br><span class="line">still starting...</span><br><span class="line">curl: (28) Operation timed out after 1001 milliseconds with 0 out of 0 bytes received</span><br><span class="line">still starting...</span><br><span class="line">curl: (28) Operation timed out after 1001 milliseconds with 0 out of 0 bytes received</span><br><span class="line">still starting...</span><br><span class="line">curl: (28) Operation timed out after 1000 milliseconds with 0 out of 0 bytes received</span><br><span class="line">still starting...</span><br><span class="line">curl: (28) Operation timed out after 1000 milliseconds with 0 out of 0 bytes received</span><br><span class="line">still starting...</span><br><span class="line">curl: (28) Operation timed out after 1001 milliseconds with 0 out of 0 bytes received</span><br><span class="line">still starting...</span><br><span class="line">hello from axum</span><br><span class="line">bash -c   0.14s user 0.07s system 2% cpu 8.421 total</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这是一次不幸运的启动，当我看curl返回正确的 bash 咒语前，它花了3秒重新启动。</p>
<p>但是，它做了下面这些必要的事情，</p>
<ul>
<li><p>对 fly.io 进行 API 调用</p>
</li>
<li><p>这创造了一个游牧工作</p>
</li>
<li><p>最终被游牧者分配到某个地方</p>
</li>
<li><p>它通知 fly.io 它已启动</p>
</li>
<li><p>还创建了一些领事服务</p>
</li>
<li><p>最终 fly-proxy 知道这些服务</p>
</li>
<li><p>因为服务是它知道一个应用程序甚至现在存在的方式，所以它再次知道该应用程序，并且可以开始在那里路由流量。</p>
<p>  等等等等，你应该分享那么多内部细节吗？</p>
</li>
</ul>
<p>哦，别担心，他们分享过<a target="_blank" rel="noopener" href="https://fly.io/blog/a-foolish-consistency/">细节</a>。</p>
<p>那么，它适合远程开发环境吗？</p>
<h2 id="SSH服务器问题"><a href="#SSH服务器问题" class="headerlink" title="SSH服务器问题"></a>SSH服务器问题</h2><p>fly.io 提供了 SSH 服务器，但还不够好。让我们看看为什么。</p>
<p>首先，fly ssh console为您处理所有肮脏的细节。</p>
<p>如果我们想使用vanilla ssh我们必须做更多的事情。我们可以使用 fly proxy将本地端口映射到远程实例的 SSH 服务器端口。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">fly proxy 2200:22 hello-axum.internal</span></span><br><span class="line">Proxying local port 2200 to remote [hello-axum.internal]:22</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>（这里我们只有一个实例。如果我们有多个我需要使用d76c732a.vm.hello-axum.internal）</p>
<p>然后发出 SSH 密钥对：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">fly ssh issue</span></span><br><span class="line">? Select organization: Amos Wenger (personal)</span><br><span class="line">? Email address for user to issue cert:  [redacted]</span><br><span class="line"></span><br><span class="line">!!!! WARNING: We&#x27;re now prompting you to save an SSH private key and certificate       !!!! </span><br><span class="line">!!!! (the private key in &quot;id_whatever&quot; and the certificate in &quot;id_whatever-cert.pub&quot;). !!!! </span><br><span class="line">!!!! These SSH credentials are time-limited and handling them in files is clunky;      !!!! </span><br><span class="line">!!!! consider running an SSH agent and running this command with --agent. Things       !!!! </span><br><span class="line">!!!! should just sort of work like magic if you do.                                    !!!!</span><br><span class="line">? Path to store private key:  /tmp/id_rsa</span><br><span class="line">Wrote 24-hour SSH credential to /tmp/id_rsa, /tmp/id_rsa-cert.pub</span><br></pre></td></tr></table></figure>

<p>然后我们可以连接：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ssh -i /tmp/id_rsa localhost -p 2200 whoami</span><br><span class="line">(cut: fingerprint stuff)</span><br><span class="line">root</span><br></pre></td></tr></table></figure>
<p>但是我们不能，例如，在它上面代理一些端口：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ssh -i /tmp/id_rsa localhost -p 2200 -L 8080:localhost:8080</span></span><br><span class="line"><span class="meta prompt_">#</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ curl localhost:8080</span><br><span class="line">curl: (56) Recv failure: Connection reset by peer</span><br></pre></td></tr></table></figure>

<p>我不知道为什么！ssh -vvv那里不是很有帮助。但是当我尝试从 VSCode 连接时，通过将其推入我的~&#x2F;.ssh&#x2F;config：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Host hello-axum</span><br><span class="line">	HostName localhost</span><br><span class="line">	Port 2200</span><br><span class="line">	IdentityFile /tmp/id_rsa</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[19:27:01.785] Remote server is listening on 43703</span><br><span class="line">[19:27:01.785] Parsed server configuration: &#123;&quot;serverConfiguration&quot;:&#123;&quot;remoteListeningOn&quot;:&#123;&quot;port&quot;:43703&#125;,&quot;osReleaseId&quot;:&quot;debian&quot;,&quot;arch&quot;:&quot;x86_64&quot;,&quot;webUiAccessToken&quot;:&quot;&quot;,&quot;sshAuthSock&quot;:&quot;&quot;,&quot;display&quot;:&quot;&quot;,&quot;tmpDir&quot;:&quot;/tmp&quot;,&quot;platform&quot;:&quot;linux&quot;,&quot;connectionToken&quot;:&quot;1a11a111-1111-111a-aaa1-a11a11111111&quot;&#125;,&quot;downloadTime&quot;:3407,&quot;installTime&quot;:1447,&quot;serverStartTime&quot;:99,&quot;installUnpackCode&quot;:&quot;success&quot;&#125;</span><br><span class="line">[19:27:01.786] Persisting server connection details to /Users/amos/Library/Application Support/Code/User/globalStorage/ms-vscode-remote.remote-ssh/vscode-ssh-host-9a297f3d-30d9c6cd9483b2cc586687151bcbcd635f373630-0.82.1/data.json</span><br><span class="line">[19:27:01.788] Starting forwarding server. localPort 54022 -&gt; socksPort 54016 -&gt; remotePort 43703</span><br><span class="line">[19:27:01.788] Forwarding server listening on 54022</span><br><span class="line">[19:27:01.788] Waiting for ssh tunnel to be ready</span><br><span class="line">[19:27:01.789] Tunneled 43703 to local port 54022</span><br><span class="line">[19:27:01.789] Resolved &quot;ssh-remote+hello-axum&quot; to &quot;127.0.0.1:54022&quot;</span><br><span class="line">[19:27:01.790] [Forwarding server 54022] Got connection 0</span><br><span class="line">[19:27:01.796] ------</span><br><span class="line">[19:27:01.807] [Forwarding server 54022] Got connection 1</span><br><span class="line">[19:27:01.809] Failed to set up socket for dynamic port forward to remote port 43703: connect ECONNREFUSED 127.0.0.1:54016. Is the remote port correct?</span><br><span class="line">[19:27:01.809] &gt; local-server-1&gt; ssh child died, shutting down</span><br><span class="line">[19:27:01.809] Failed to set up socket for dynamic port forward to remote port 43703: Socket closed. Is the remote port correct?</span><br><span class="line">[19:27:01.812] Local server exit: 0</span><br></pre></td></tr></table></figure>

<p>所以，我们需要一个更好的 SSH 服务器。而且，就个人而言，我不想每次想要连接到我的远程开发环境时都必须运行（flyctl 命令，而不是在 fly 应用程序前面运行的 TCP&#x2F;HTTP 代理）。</p>
<p>哦，SSH 密钥会在 24 小时后过期。而且您无法配置 SSH 服务器，因为它是内置的（除非我遗漏了什么）。</p>
<p>因此，将其与缓慢的启动&#x2F;停止时间结合起来，事情看起来不太好。（特别是因为我们不清楚如何启动&#x2F;停止单个实例。玩弄并fly regions实现fly scale它听起来很危险！）</p>
<h2 id="输入-fly-io-机器"><a href="#输入-fly-io-机器" class="headerlink" title="输入 fly.io 机器"></a>输入 fly.io 机器</h2><p>描述 fly.io 机器的最佳方式就是“firecracker microVMs as a service”，中间没有 Nomad&#x2F;Consul。</p>
<p>为此，我们需要一个新的 fly.io 应用程序——您现在不能只将机器添加到常规应用程序（或永远？我不是这里的 PM）。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">fly apps create</span></span><br><span class="line">? App Name: axum-machine</span><br><span class="line">? Select Organization: Amos Wenger (personal)</span><br><span class="line">New app created: axum-machine</span><br></pre></td></tr></table></figure>

<p>因为我不喜欢每次都 指定-a&#x2F;-app ，所以我将编辑并更改该行以读取“axum-machine”而不是“hello-axum”。文件的其余部分对machine无关紧要。–appfly.tomlapp &#x3D;</p>
<p>然后我们可以运行相同的 Docker 镜像，但作为一个fly machine：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">fly machines run --port 80:8080/tcp:http --port 443:8080/tcp:http:tls --region cdg --size shared-cpu-1x hello-axum</span></span><br><span class="line">Searching for image &#x27;hello-axum&#x27; locally...</span><br><span class="line">image found: sha256:3f93ceb9158f5e123253060d58d607f7c2a7e2f93797b49b4edbbbcc8e1b3840</span><br><span class="line">==&gt; Pushing image to fly</span><br><span class="line">The push refers to repository [registry.fly.io/axum-machine]</span><br><span class="line">02f75279051e: Layer already exists </span><br><span class="line">4e38e245312b: Layer already exists </span><br><span class="line">85ade8c6ca76: Layer already exists </span><br><span class="line">ad6562704f37: Layer already exists </span><br><span class="line">deployment-1655573668: digest: sha256:1ddfda6a6d8d84d804602653501db1c9720677b6e04e31008d3256c53ec09723 size: 1159</span><br><span class="line"><span class="meta prompt_">--&gt; </span><span class="language-bash">Pushing image <span class="keyword">done</span></span></span><br><span class="line">Image: registry.fly.io/axum-machine:deployment-1655573668</span><br><span class="line">Image size: 152 MB</span><br><span class="line">Machine is launching...</span><br><span class="line">Success! A machine has been successfully launched, waiting for it to be started</span><br><span class="line"> Machine ID: 217814d9c9ee89</span><br><span class="line"> Instance ID: 01G5VY2TKH0A1MQWSX05S1GPK8</span><br><span class="line"> State: starting</span><br><span class="line">Waiting on firecracker VM...</span><br><span class="line">Waiting on firecracker VM...</span><br><span class="line">Waiting on firecracker VM...</span><br><span class="line">Machine started, you can connect via the following private ip</span><br><span class="line">  fdaa:0:446c:a7b:5b66:d530:1a4b:2</span><br></pre></td></tr></table></figure>
<p>请注意，推送图像是即时的，因为它已经存在于 fly 的镜像仓库。</p>
<p>你可以看到那里没有提到分配或任何东西：它只是根据要求启动一个虚拟机，并给我们它的私有 IPv6 地址。</p>
<p>这只有在我们建立私人网络时才有效，我现在懒得去做。</p>
<p>相反，让我们检查一下我们是否仍然可以使用默认的 SSH 服务器通过 SSH 连接到它：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">fly ssh console</span></span><br><span class="line">Connecting to top1.nearest.of.axum-machine.internal... complete</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">whoami</span></span></span><br><span class="line">root</span><br></pre></td></tr></table></figure>

<p>到目前为止，一切都很好。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">fly status</span></span><br><span class="line">App</span><br><span class="line">  Name     = axum-machine          </span><br><span class="line">  Owner    = personal              </span><br><span class="line">  Version  = 0                     </span><br><span class="line">  Status   = pending               </span><br><span class="line">  Hostname = axum-machine.fly.dev  </span><br><span class="line"></span><br><span class="line">Machines</span><br><span class="line">ID              NAME                    REGION  STATE   CREATED              </span><br><span class="line">217814d9c9ee89  ancient-snowflake-1933  cdg     started 2022-06-18T17:34:30Z</span><br></pre></td></tr></table></figure>

<p>这也有效，并显示我们的机器正在运行。棒！</p>
<p>我们还有：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">fly m list</span></span><br><span class="line">1 machines have been retrieved.</span><br><span class="line">View them in the UI here (​https://fly.io/apps/axum-machine/machines/)</span><br><span class="line"></span><br><span class="line">axum-machine</span><br><span class="line">ID              IMAGE                                   CREATED                 STATE   REGION  NAME                    IP ADDRESS                       </span><br><span class="line">217814d9c9ee89  axum-machine:deployment-1655573668      2022-06-18T17:34:30Z    started cdg     ancient-snowflake-1933  fdaa:0:446c:a7b:5b66:d530:1a4b:2</span><br></pre></td></tr></table></figure>

<p>..其中有更多细节。</p>
<p>我们的应用程序目前没有公共 IP，因此无法使用 curl 访问域。</p>
<p>但我们可以分配一个 - 我会选择 IPv6，因为我有它，而 IPv4 地址是一种宝贵的商品。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">fly ips allocate-v6</span></span><br><span class="line">TYPE ADDRESS           REGION CREATED AT </span><br><span class="line">v6   2a09:8280:1::48d5 global 1s ago</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>现在这行得通了！</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -i https://axum-machine.fly.dev</span></span><br><span class="line">HTTP/2 200 </span><br><span class="line">content-type: text/plain; charset=utf-8</span><br><span class="line">content-length: 16</span><br><span class="line">date: Sat, 18 Jun 2022 17:39:27 GMT</span><br><span class="line">server: Fly/09a15cede3 (2022-06-17)</span><br><span class="line">via: 2 fly.io</span><br><span class="line">fly-request-id: 01G5VYBX04VT7JDNQF626KGZ52-cdg</span><br><span class="line"></span><br><span class="line">hello from axum</span><br></pre></td></tr></table></figure>

<p>最妙的是：我们可以停止machine。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">fly m stop 217814d9c9ee89</span></span><br><span class="line">217814d9c9ee89 has been successfully stopped</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">fly m status 217814d9c9ee89</span></span><br><span class="line">Success! A machine has been retrieved</span><br><span class="line"> Machine ID: 217814d9c9ee89</span><br><span class="line"> Instance ID: 01G5VY2TKH0A1MQWSX05S1GPK8</span><br><span class="line"> State: stopped</span><br><span class="line"></span><br><span class="line">Event Logs</span><br><span class="line">MACHINE STATUS  EVENT TYPE      SOURCE  TIMESTAMP                </span><br><span class="line">stopped         exit            flyd    2022-06-18T17:40:38.517Z</span><br><span class="line">stopping        stop            user    2022-06-18T17:40:35.245Z</span><br><span class="line">started         start           flyd    2022-06-18T17:34:41.353Z</span><br><span class="line">created         launch          user    2022-06-18T17:34:30.538Z</span><br></pre></td></tr></table></figure>

<p>我们可以在事件日志中看到它确实停止了。</p>
<p>现在，如果我们尝试再次运行我们的curl……</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -i https://axum-machine.fly.dev</span></span><br><span class="line">HTTP/2 200 </span><br><span class="line">content-type: text/plain; charset=utf-8</span><br><span class="line">content-length: 16</span><br><span class="line">date: Sat, 18 Jun 2022 17:41:46 GMT</span><br><span class="line">server: Fly/09a15cede3 (2022-06-17)</span><br><span class="line">via: 2 fly.io</span><br><span class="line">fly-request-id: 01G5VYG3JYZFJ0871A26DCYGKT-cdg</span><br><span class="line"></span><br><span class="line">hello from axum</span><br></pre></td></tr></table></figure>

<p>它……还能用吗？</p>
<pre><code>惊喜！震惊！敬畏！可预见的情节转折！
</code></pre>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">fly m status 217814d9c9ee89</span></span><br><span class="line">Success! A machine has been retrieved</span><br><span class="line"> Machine ID: 217814d9c9ee89</span><br><span class="line"> Instance ID: 01G5VY2TKH0A1MQWSX05S1GPK8</span><br><span class="line"> State: started</span><br><span class="line"></span><br><span class="line">Event Logs</span><br><span class="line">MACHINE STATUS  EVENT TYPE      SOURCE  TIMESTAMP                </span><br><span class="line">started         start           flyd    2022-06-18T17:41:46.075Z</span><br><span class="line">starting        start           user    2022-06-18T17:41:45.695Z</span><br><span class="line">stopped         exit            flyd    2022-06-18T17:40:38.517Z</span><br><span class="line">stopping        stop            user    2022-06-18T17:40:35.245Z</span><br><span class="line">started         start           flyd    2022-06-18T17:34:41.353Z</span><br><span class="line">created         launch          user    2022-06-18T17:34:30.538Z</span><br></pre></td></tr></table></figure>

<p>呵呵，又开始了。</p>
<pre><code>阿莫斯没有假装惊讶。你在那个功能上工作。你很清楚它的作用。
</code></pre>
<p>好的好的，好的。因此，如果您为具有机器的应用程序访问公共端口，它会尝试启动一台机器来处理连接（原始 TCP）&#x2F;请求（HTTP）。</p>
<p>我们绝对可以利用它来发挥我们的优势。</p>
<pre><code>你在想什么？暴露22端口？
</code></pre>
<p>嗯，是！让我们试试吧。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">fly m remove --force 217814d9c9ee89</span></span><br><span class="line">machine 217814d9c9ee89 was found and is currently in started state, attempting to destroy...</span><br><span class="line">217814d9c9ee89 has been destroyed</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">fly machines run --app axum-machine --port 22:22/tcp --region cdg --size shared-cpu-1x hello-axum</span></span><br><span class="line">Searching for image &#x27;hello-axum&#x27; locally...</span><br><span class="line">image found: sha256:3f93ceb9158f5e123253060d58d607f7c2a7e2f93797b49b4edbbbcc8e1b3840</span><br><span class="line">==&gt; Pushing image to fly</span><br><span class="line">The push refers to repository [registry.fly.io/axum-machine]</span><br><span class="line">02f75279051e: Layer already exists </span><br><span class="line">4e38e245312b: Layer already exists </span><br><span class="line">85ade8c6ca76: Layer already exists </span><br><span class="line">ad6562704f37: Layer already exists </span><br><span class="line">deployment-1655574325: digest: sha256:1ddfda6a6d8d84d804602653501db1c9720677b6e04e31008d3256c53ec09723 size: 1159</span><br><span class="line"><span class="meta prompt_">--&gt; </span><span class="language-bash">Pushing image <span class="keyword">done</span></span></span><br><span class="line">Image: registry.fly.io/axum-machine:deployment-1655574325</span><br><span class="line">Image size: 152 MB</span><br><span class="line">Machine is launching...</span><br><span class="line">Success! A machine has been successfully launched, waiting for it to be started</span><br><span class="line"> Machine ID: 5918536ef46383</span><br><span class="line"> Instance ID: 01G5VYPX14END6ZPAHBB411304</span><br><span class="line"> State: starting</span><br><span class="line">Waiting on firecracker VM...</span><br><span class="line">Waiting on firecracker VM...</span><br><span class="line">Machine started, you can connect via the following private ip</span><br><span class="line">  fdaa:0:446c:a7b:5adc:24:e81f:2</span><br></pre></td></tr></table></figure>

<p>进而：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ssh -vvv -i /tmp/id_rsa root@axum-machine.fly.dev</span></span><br><span class="line">OpenSSH_8.2p1 Ubuntu-4ubuntu0.5, OpenSSL 1.1.1f  31 Mar 2020</span><br><span class="line">debug1: Reading configuration data /etc/ssh/ssh_config</span><br><span class="line">debug1: /etc/ssh/ssh_config line 19: include /etc/ssh/ssh_config.d/*.conf matched no files</span><br><span class="line">debug1: /etc/ssh/ssh_config line 21: Applying options for *</span><br><span class="line">debug2: resolving &quot;axum-machine.fly.dev&quot; port 22</span><br><span class="line">debug2: ssh_connect_direct</span><br><span class="line">debug1: Connecting to axum-machine.fly.dev [2a09:8280:1::48d5] port 22.</span><br><span class="line">debug1: Connection established.</span><br><span class="line">debug1: identity file /tmp/id_rsa type -1</span><br><span class="line">debug1: identity file /tmp/id_rsa-cert type 7</span><br><span class="line">debug1: Local version string SSH-2.0-OpenSSH_8.2p1 Ubuntu-4ubuntu0.5</span><br></pre></td></tr></table></figure>

<p>嗯，卡住了。</p>
<p>让我们检查应用程序日志…</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">2022-06-18T17:47:43Z proxy[5918536ef46383] cdg [info]Machine not ready yet (11.072820024s since start requested)</span></span><br><span class="line">2022-06-18T17:47:44Z proxy[5918536ef46383] cdg [info]Machine not ready yet (15.250221892s since start requested)</span><br><span class="line">2022-06-18T17:47:45Z proxy[5918536ef46383] cdg [info]Machine not ready yet (33.956303928s since start requested)</span><br><span class="line">2022-06-18T17:47:47Z proxy[5918536ef46383] cdg [info]Machine not ready yet (5.409191838s since start requested)</span><br><span class="line">2022-06-18T17:47:48Z proxy[5918536ef46383] cdg [info]Machine not ready yet (10.043353267s since start requested)</span><br><span class="line">2022-06-18T17:47:48Z proxy[5918536ef46383] cdg [info]Machine not ready yet (16.080325672s since start requested)</span><br><span class="line">2022-06-18T17:47:50Z proxy[5918536ef46383] cdg [info]Machine not ready yet (38.962990983s since start requested)</span><br><span class="line">^C%                               </span><br></pre></td></tr></table></figure>

<p>我的天。22 端口上没有监听吗？</p>
<p>让我们检查…</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">fly ssh console</span></span><br><span class="line">Connecting to top1.nearest.of.axum-machine.internal... complete</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ss -lpn</span></span><br><span class="line">Netid    State     Recv-Q    Send-Q                          Local Address:Port          Peer Address:Port    Process                                 </span><br><span class="line">nl       UNCONN    0         0                                           0:0                         *                                                </span><br><span class="line">(cut)</span><br><span class="line">nl       UNCONN    0         0                                          18:0                         *                                                </span><br><span class="line">tcp      LISTEN    0         0                                           *:8080                     *:*        users:((&quot;hello-axum&quot;,pid=508,fd=9))    </span><br><span class="line">tcp      LISTEN    0         0            [fdaa:0:446c:a7b:5adc:24:e81f:2]:22                       *:*        users:((&quot;hallpass&quot;,pid=509,fd=6))      </span><br><span class="line">v_str    LISTEN    0         0                                           3:10000                    *:*        users:((&quot;init&quot;,pid=1,fd=9))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>啊! 端口 22 上有一个监听器，称为“hallpass”。但它正在监听……私有 IPv6 地址。不是特殊0.0.0.0&#x2F;:: 地址。</p>
<p>所以那是行不通的。</p>
<p>没问题，我们将运行我们自己的 SSH 服务器！</p>
<p>让我们也添加一个非 root 用户，除了……我已经习惯了！我通常有一个非 root 用户，使用无密码 sudo，SSH 的仅密钥身份验证。这并不是真正为了安全，更多的是为了避免在没有sudo的情况下对系统文件造成破坏。</p>
<p>我还切换到 Ubuntu 20.04 base，我觉得使用起来比 Debian 更舒服：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># in `hello-axum/Dockerfile`</span></span><br><span class="line"><span class="comment"># syntax = docker/dockerfile:1.4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">################################################################################</span></span><br><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">set</span> -eux; \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">export</span> DEBIAN_FRONTEND=noninteractive; \</span></span><br><span class="line"><span class="language-bash">	  apt update; \</span></span><br><span class="line"><span class="language-bash">		apt install --<span class="built_in">yes</span> --no-install-recommends \</span></span><br><span class="line"><span class="language-bash">			bind9-dnsutils iputils-ping iproute2 curl ca-certificates htop \</span></span><br><span class="line"><span class="language-bash">			curl wget ca-certificates git-core \</span></span><br><span class="line"><span class="language-bash">			openssh-server openssh-client \</span></span><br><span class="line"><span class="language-bash">			sudo less zsh \</span></span><br><span class="line"><span class="language-bash">			; \</span></span><br><span class="line"><span class="language-bash">		apt clean autoclean; \</span></span><br><span class="line"><span class="language-bash">		apt autoremove --<span class="built_in">yes</span>; \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">rm</span> -rf /var/lib/&#123;apt,dpkg,cache,<span class="built_in">log</span>&#125;/; \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">echo</span> <span class="string">&quot;Installed base utils!&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">set</span> -eux; \</span></span><br><span class="line"><span class="language-bash">		useradd -ms /usr/bin/zsh amos; \</span></span><br><span class="line"><span class="language-bash">		usermod -aG sudo amos; \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">echo</span> <span class="string">&#x27;%sudo ALL=(ALL) NOPASSWD:ALL&#x27;</span> &gt;&gt; /etc/sudoers; \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">echo</span> <span class="string">&quot;added user&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">set</span> -eux; \</span></span><br><span class="line"><span class="language-bash"></span></span><br><span class="line">		echo <span class="string">&quot;Port 22&quot;</span> &gt;&gt; /etc/ssh/sshd_config; \</span><br><span class="line">		echo <span class="string">&quot;AddressFamily inet&quot;</span> &gt;&gt; /etc/ssh/sshd_config; \</span><br><span class="line">		echo <span class="string">&quot;ListenAddress 0.0.0.0&quot;</span> &gt;&gt; /etc/ssh/sshd_config; \</span><br><span class="line">		echo <span class="string">&quot;PasswordAuthentication no&quot;</span> &gt;&gt; /etc/ssh/sshd_config; \</span><br><span class="line">		echo <span class="string">&quot;ClientAliveInterval 30&quot;</span> &gt;&gt; /etc/ssh/sshd_config; \</span><br><span class="line">		echo <span class="string">&quot;ClientAliveCountMax 10&quot;</span> &gt;&gt; /etc/ssh/sshd_config; \</span><br><span class="line">		echo <span class="string">&quot;SSH server set up&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">USER</span> amos</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">set</span> -eux; \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">mkdir</span> ~/.ssh; \</span></span><br><span class="line"><span class="language-bash">		curl https://github.com/fasterthanlime.keys | <span class="built_in">tee</span> -a ~/.ssh/authorized_keys</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;sudo service ssh start; echo &#x27;SSH server started&#x27;; sleep infinity&quot;</span>]</span></span><br></pre></td></tr></table></figure>


<p>（请注意，我们也不再构建任何 Rust。此外， 那里的配置ClientAliveInterval有助于减少 fly 的默认 TCP 空闲超时。它ClientAliveInterval确保只要你连接，即使您的 SSH 会话并不活跃。）</p>
<p>让我们再次构建它：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker build -t hello-axum .</span></span><br></pre></td></tr></table></figure>

<p>并创建一台新机器，确保这次我们公开端口 22。</p>
<p>注意：有一种方法可以通过传递–id ID给 来fly m run替换机器，但是在撰写本文时，它存在状态更新问题，因此在这些问题得到解决之前，我们将继续删除&#x2F;重新创建机器。除了不重复使用 ID 之外，它没有任何区别。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">fly m remove --force 5918536ef46383</span></span><br><span class="line">(cut)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">fly m run -p 22:22/tcp -r cdg -s shared-cpu-8x hello-axum</span></span><br><span class="line">(cut)</span><br></pre></td></tr></table></figure>

<p>还有……瞧！</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ssh axum-machine.fly.dev <span class="built_in">whoami</span></span></span><br><span class="line">amos</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>现在我们实际上可以使用 VS Code 登录机器，而且它不会报错！</p>
<p>我们所要做的就是将它添加到我们的本地~&#x2F;.ssh&#x2F;config</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Host hello-axum</span><br><span class="line">	HostName axum-machine.fly.dev</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后我们选择要连接的机器：</p>
<p><img src="/remote-development-with-rust-on-fly-io/1.avif" alt="1"></p>
<p>我们可以编辑远程文件，打开任意终端，就像我们通常在 VS Code 中所做的那样工作，除了……远程。</p>
<p><img src="/remote-development-with-rust-on-fly-io/2.avif" alt="2"></p>
<p>与如果我们在 ssh 上使用 vim 之类的东西相比，延迟不是一个问题，因为它不需要等待发送单个击键然后等待终端回显。它比那更复杂一点。</p>
<p>不过，很有可能有一个 fly.io 区域，那里的延迟对您来说还算不错 。对我来说是~10ms：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ping6 axum-machine.fly.dev</span></span><br><span class="line">PING6(56=40+8+8 bytes) [redacted] --&gt; 2a09:8280:1::48d5</span><br><span class="line">16 bytes from 2a09:8280:1::48d5, icmp_seq=0 hlim=52 time=15.792 ms</span><br><span class="line">16 bytes from 2a09:8280:1::48d5, icmp_seq=1 hlim=52 time=13.238 ms</span><br><span class="line">16 bytes from 2a09:8280:1::48d5, icmp_seq=2 hlim=52 time=8.906 ms</span><br><span class="line">^C</span><br><span class="line">--- axum-machine.fly.dev ping6 statistics ---</span><br><span class="line">3 packets transmitted, 3 packets received, 0.0% packet loss</span><br><span class="line">round-trip min/avg/max/std-dev = 8.906/12.645/15.792/2.842 ms</span><br></pre></td></tr></table></figure>

<p>VS Code 也知道如何自动转发端口（如果检测失败则手动转发），所以如果我们在那边启动一个小服务器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo apt update &amp;&amp; sudo apt install -y python</span></span><br><span class="line">(cut)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> /etc</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">python -m SimpleHTTPServer</span></span><br></pre></td></tr></table></figure>
<p><img src="/remote-development-with-rust-on-fly-io/3.avif" alt="3"></p>
<p>然后 VS Code 自动将端口转发到本地主机：</p>
<p><img src="/remote-development-with-rust-on-fly-io/4.avif" alt="4"><br>我们可以从本地桌面浏览器打开它：</p>
<p><img src="/remote-development-with-rust-on-fly-io/6.avif" alt="6"></p>
<p>还有一些我喜欢的 VS Code 扩展，比如Resource Monitor，这对我来说是一个非常理想的设置。</p>
<p>哎呀，你甚至可能想出一种方法将远程机器上的某个文件夹挂载到你的本地机器上，通过类似 sshfs 的东西，但是这个项目显然不再维护？所以maintained 也许是一个维护的替代方案。</p>
<p>哦，你想要Volume。您可以使用fly volumes（或fly vol简称）创建它们并通过传递–volume vol_name:&#x2F;path&#x2F;on&#x2F;disk.</p>
<p>  该 CLI 选项目前在 flyctl 文档中是隐藏的。这将是我们的小秘密！</p>
<p>  注意事项是：它仍然是实验性的，而且您只能使用一个volume（与“经典”fly 应用程序相反）。</p>
<p>在那种环境中的一件好事是您可以轻松地运行 Docker！将它添加到我们的示例 Dockerfile 中有点麻烦，但我是从我的远程环境中输入的，我可以保证它确实会运行 docker：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker info</span></span><br><span class="line">(cut)</span><br><span class="line">  app: Docker App (Docker Inc., v0.9.1-beta3)</span><br><span class="line">  buildx: Docker Buildx (Docker Inc., v0.8.2-docker)</span><br><span class="line">  compose: Docker Compose (Docker Inc., v2.6.0)</span><br><span class="line">(cut)</span><br><span class="line">Server:</span><br><span class="line"> Server Version: 20.10.17</span><br><span class="line"> Storage Driver: overlay2</span><br><span class="line"> (cut)</span><br><span class="line"> containerd version: 10c12954828e7c7c9b6e0ea9b0c02b01407d3ae1</span><br><span class="line"> runc version: v1.1.2-0-ga916309</span><br><span class="line"> init version: de40ad0</span><br><span class="line"> Security Options:</span><br><span class="line">  seccomp</span><br><span class="line">   Profile: default</span><br><span class="line"> Kernel Version: 5.12.2</span><br><span class="line"> Operating System: Ubuntu 20.04.4 LTS</span><br><span class="line"> OSType: linux</span><br><span class="line"> Architecture: x86_64</span><br><span class="line"> CPUs: 8</span><br><span class="line"> Total Memory: 15.63GiB</span><br><span class="line"> (cut)</span><br></pre></td></tr></table></figure>


<p>还有，还有！同样，因为这是一个真正的虚拟机，而不仅仅是一个 docker 容器，我们可以安装类似的东西perf！</p>
<p>我们必须从源代码构建它，但这没问题：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">KERNEL_VERSION=$(uname -r | sed -r &#x27;s/(^[^-]+).*/\1/&#x27; | sed -r &#x27;s/\.0//g&#x27;)</span><br><span class="line">echo &quot;Installing perf for kernel $&#123;KERNEL_VERSION&#125;&quot;</span><br><span class="line"></span><br><span class="line">mkdir ~/kernel-sources</span><br><span class="line">cd ~/kernel-sources</span><br><span class="line">curl --fail --location &quot;https://mirrors.edge.kernel.org/pub/linux/kernel/v5.x/linux-$&#123;KERNEL_VERSION&#125;.tar.xz&quot; | tar -xJ --strip-components=1</span><br><span class="line">sudo apt install --yes libiberty-dev binutils-dev flex bison libelf-dev libunwind-dev liblzma-dev libzstd-dev libdw-dev</span><br><span class="line">sudo make -C tools/ perf_install prefix=/usr/</span><br></pre></td></tr></table></figure>

<p>然后我们可以看到 CPU 时间花在哪里了perf top！</p>
<p><img src="/remote-development-with-rust-on-fly-io/7.avif" alt="7"></p>
<p>有关详细信息，请参阅Brendan Gregg 的性能页面。</p>
<p>我们的小设置只有一个问题，它与价格有关。</p>
<p>machine只有在你调用<code>fly m stop --id MACHINE_ID</code> 才会停止。</p>
<p>我希望它在“暂时不使用”时停止。</p>
<p>我们可以解决这个问题……用 Rust。</p>
<pre><code>又来了
</code></pre>
<h2 id="带有-tokio-的简单-TCP-代理"><a href="#带有-tokio-的简单-TCP-代理" class="headerlink" title="带有 tokio 的简单 TCP 代理"></a>带有 tokio 的简单 TCP 代理</h2><p>这就是我在“生产”中使用的，可以这么说。这绝对不是唯一的方法，事实上我们会看看是否有时间用其他一些有趣的方法来做，但它简单直接，我喜欢它。</p>
<p>我们不需要为此使用 axum，因为我们只想说 TCP，而不是 HTTP。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in `hello-axum/src/main.rs`</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> std::&#123;</span><br><span class="line">    process::Stdio,</span><br><span class="line">    sync::&#123;</span><br><span class="line">        atomic::&#123;AtomicU64, Ordering&#125;,</span><br><span class="line">        Arc,</span><br><span class="line">    &#125;,</span><br><span class="line">    time::&#123;Duration, Instant&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> tokio::&#123;</span><br><span class="line">    net::&#123;TcpListener, TcpStream&#125;,</span><br><span class="line">    process::Command,</span><br><span class="line">    time::sleep,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[tokio::main]</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">status</span> = Command::<span class="title function_ invoke__">new</span>(<span class="string">&quot;service&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">arg</span>(<span class="string">&quot;ssh&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">arg</span>(<span class="string">&quot;start&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">stdin</span>(Stdio::<span class="title function_ invoke__">null</span>())</span><br><span class="line">        .<span class="title function_ invoke__">stdout</span>(Stdio::<span class="title function_ invoke__">inherit</span>())</span><br><span class="line">        .<span class="title function_ invoke__">stderr</span>(Stdio::<span class="title function_ invoke__">inherit</span>())</span><br><span class="line">        .<span class="title function_ invoke__">status</span>()</span><br><span class="line">        .<span class="keyword">await</span></span><br><span class="line">        .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="built_in">assert!</span>(status.<span class="title function_ invoke__">success</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">num_conns</span>: Arc&lt;AtomicU64&gt; = <span class="built_in">Default</span>::<span class="title function_ invoke__">default</span>();</span><br><span class="line"></span><br><span class="line">    tokio::<span class="title function_ invoke__">spawn</span>(&#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">num_conns</span> = num_conns.<span class="title function_ invoke__">clone</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">last_activity</span> = Instant::<span class="title function_ invoke__">now</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">move</span> &#123;</span><br><span class="line">            <span class="keyword">loop</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> num_conns.<span class="title function_ invoke__">load</span>(Ordering::SeqCst) &gt; <span class="number">0</span> &#123;</span><br><span class="line">                    last_activity = Instant::<span class="title function_ invoke__">now</span>();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">let</span> <span class="variable">idle_time</span> = last_activity.<span class="title function_ invoke__">elapsed</span>();</span><br><span class="line">                    <span class="built_in">println!</span>(<span class="string">&quot;Idle for &#123;idle_time:?&#125;&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> idle_time &gt; Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">60</span>) &#123;</span><br><span class="line">                        <span class="built_in">println!</span>(<span class="string">&quot;Stopping machine. Goodbye!&quot;</span>);</span><br><span class="line">                        std::process::<span class="title function_ invoke__">exit</span>(<span class="number">0</span>)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">5</span>)).<span class="keyword">await</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">listener</span> = TcpListener::<span class="title function_ invoke__">bind</span>(<span class="string">&quot;[::]:2222&quot;</span>).<span class="keyword">await</span>.<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">let</span> <span class="variable">Ok</span>((<span class="keyword">mut</span> ingress, _)) = listener.<span class="title function_ invoke__">accept</span>().<span class="keyword">await</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">num_conns</span> = num_conns.<span class="title function_ invoke__">clone</span>();</span><br><span class="line">        tokio::<span class="title function_ invoke__">spawn</span>(<span class="keyword">async</span> <span class="keyword">move</span> &#123;</span><br><span class="line">            <span class="comment">// We&#x27;ll tell OpenSSH to listen on this IPv4 address.</span></span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">egress</span> = TcpStream::<span class="title function_ invoke__">connect</span>(<span class="string">&quot;127.0.0.2:22&quot;</span>).<span class="keyword">await</span>.<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            <span class="comment">// did you know: loopback is 127.0.0.1/8, it goes all the way to</span></span><br><span class="line">            <span class="comment">// 127.255.255.254 (and 127.255.255.255 for broadcast)</span></span><br><span class="line"></span><br><span class="line">            num_conns.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Ordering::SeqCst);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">match</span> tokio::io::<span class="title function_ invoke__">copy_bidirectional</span>(&amp;<span class="keyword">mut</span> ingress, &amp;<span class="keyword">mut</span> egress).<span class="keyword">await</span> &#123;</span><br><span class="line">                <span class="title function_ invoke__">Ok</span>((to_egress, to_ingress)) =&gt; &#123;</span><br><span class="line">                    <span class="built_in">println!</span>(</span><br><span class="line">                        <span class="string">&quot;Connection ended gracefully (&#123;to_egress&#125; bytes from client, &#123;to_ingress&#125; bytes from server)&quot;</span></span><br><span class="line">                    );</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="title function_ invoke__">Err</span>(err) =&gt; &#123;</span><br><span class="line">                    <span class="built_in">println!</span>(<span class="string">&quot;Error while proxying: &#123;&#125;&quot;</span>, err);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            num_conns.<span class="title function_ invoke__">fetch_sub</span>(<span class="number">1</span>, Ordering::SeqCst);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>等等…停止机器只是std::process::exit？</p>
<p>是的！如果我们的 docker 镜像的“CMD”退出，机器就会停止。在这种情况下，从内部判断机器是否需要停止就容易多了。</p>
<p>（如果我们只能从外部判断，我们会使用机器 API来阻止它。）</p>
<p>不管怎样，这是我们调整后的 Dockerfile：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># in `hello-axum/Dockerfile`</span></span><br><span class="line"><span class="comment"># syntax = docker/dockerfile:1.4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">################################################################################</span></span><br><span class="line"><span class="comment"># Let&#x27;s just make our own Rust builder image based on ubuntu:20.04 to avoid</span></span><br><span class="line"><span class="comment"># any libc version problems</span></span><br><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span> AS builder</span><br><span class="line"></span><br><span class="line"><span class="comment"># Install base utils: curl to grab rustup, gcc + build-essential for linking.</span></span><br><span class="line"><span class="comment"># we could probably reduce that a bit but /shrug</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">set</span> -eux; \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">export</span> DEBIAN_FRONTEND=noninteractive; \</span></span><br><span class="line"><span class="language-bash">		apt update; \</span></span><br><span class="line"><span class="language-bash">		apt install --<span class="built_in">yes</span> --no-install-recommends \</span></span><br><span class="line"><span class="language-bash">			curl ca-certificates \</span></span><br><span class="line"><span class="language-bash">			gcc build-essential \</span></span><br><span class="line"><span class="language-bash">			; \</span></span><br><span class="line"><span class="language-bash">		apt clean autoclean; \</span></span><br><span class="line"><span class="language-bash">		apt autoremove --<span class="built_in">yes</span>; \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">rm</span> -rf /var/lib/&#123;apt,dpkg,cache,<span class="built_in">log</span>&#125;/; \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">echo</span> <span class="string">&quot;Installed base utils!&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Install rustup</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">set</span> -eux; \</span></span><br><span class="line"><span class="language-bash">		curl --location --fail \</span></span><br><span class="line"><span class="language-bash">			<span class="string">&quot;https://static.rust-lang.org/rustup/dist/x86_64-unknown-linux-gnu/rustup-init&quot;</span> \</span></span><br><span class="line"><span class="language-bash">			--output rustup-init; \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">chmod</span> +x rustup-init; \</span></span><br><span class="line"><span class="language-bash">		./rustup-init -y --no-modify-path; \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">rm</span> rustup-init;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add rustup to path, check that it works</span></span><br><span class="line"><span class="keyword">ENV</span> PATH=$&#123;PATH&#125;:/root/.cargo/bin</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">set</span> -eux; \</span></span><br><span class="line"><span class="language-bash">		rustup --version;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Build some code!</span></span><br><span class="line"><span class="comment"># Careful: now we need to cache `/root/.cargo/` rather than `/usr/local/cargo`</span></span><br><span class="line"><span class="comment"># since rustup installed things differently than in the rust build image</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> --mount=<span class="built_in">type</span>=cache,target=/app/target \</span></span><br><span class="line"><span class="language-bash">		--mount=<span class="built_in">type</span>=cache,target=/root/.cargo/registry \</span></span><br><span class="line"><span class="language-bash">		--mount=<span class="built_in">type</span>=cache,target=/root/.cargo/git \</span></span><br><span class="line"><span class="language-bash">		--mount=<span class="built_in">type</span>=cache,target=/root/.rustup \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">set</span> -eux; \</span></span><br><span class="line"><span class="language-bash">		rustup install stable; \</span></span><br><span class="line"><span class="language-bash">	 	cargo build --release; \</span></span><br><span class="line"><span class="language-bash">		objcopy --compress-debug-sections target/release/hello-axum ./hello-axum</span></span><br><span class="line"></span><br><span class="line"><span class="comment">################################################################################</span></span><br><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">set</span> -eux; \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">export</span> DEBIAN_FRONTEND=noninteractive; \</span></span><br><span class="line"><span class="language-bash">	  apt update; \</span></span><br><span class="line"><span class="language-bash">		apt install --<span class="built_in">yes</span> --no-install-recommends \</span></span><br><span class="line"><span class="language-bash">			bind9-dnsutils iputils-ping iproute2 curl ca-certificates htop \</span></span><br><span class="line"><span class="language-bash">			curl wget ca-certificates git-core \</span></span><br><span class="line"><span class="language-bash">			openssh-server openssh-client \</span></span><br><span class="line"><span class="language-bash">			sudo less zsh \</span></span><br><span class="line"><span class="language-bash">			; \</span></span><br><span class="line"><span class="language-bash">		apt clean autoclean; \</span></span><br><span class="line"><span class="language-bash">		apt autoremove --<span class="built_in">yes</span>; \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">rm</span> -rf /var/lib/&#123;apt,dpkg,cache,<span class="built_in">log</span>&#125;/; \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">echo</span> <span class="string">&quot;Installed base utils!&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">set</span> -eux; \</span></span><br><span class="line"><span class="language-bash">		useradd -ms /usr/bin/zsh amos; \</span></span><br><span class="line"><span class="language-bash">		usermod -aG sudo amos; \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">echo</span> <span class="string">&#x27;%sudo ALL=(ALL) NOPASSWD:ALL&#x27;</span> &gt;&gt; /etc/sudoers; \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">echo</span> <span class="string">&quot;added user&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Note that we&#x27;ve changed the `ListenAddress` here from `0.0.0.0` to</span></span><br><span class="line"><span class="comment"># `127.0.0.2`. It&#x27;s not really necessary but it&#x27;s neat that 127.0.0.1 is a /8.</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">set</span> -eux; \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">echo</span> <span class="string">&quot;Port 22&quot;</span> &gt;&gt; /etc/ssh/sshd_config; \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">echo</span> <span class="string">&quot;AddressFamily inet&quot;</span> &gt;&gt; /etc/ssh/sshd_config; \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">echo</span> <span class="string">&quot;ListenAddress 127.0.0.2&quot;</span> &gt;&gt; /etc/ssh/sshd_config; \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">echo</span> <span class="string">&quot;PasswordAuthentication no&quot;</span> &gt;&gt; /etc/ssh/sshd_config; \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">echo</span> <span class="string">&quot;ClientAliveInterval 30&quot;</span> &gt;&gt; /etc/ssh/sshd_config; \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">echo</span> <span class="string">&quot;ClientAliveCountMax 10&quot;</span> &gt;&gt; /etc/ssh/sshd_config; \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">echo</span> <span class="string">&quot;SSH server set up&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">USER</span> amos</span><br><span class="line"></span><br><span class="line"><span class="comment"># Don&#x27;t forget to change that if you don&#x27;t want to give /me/ access to your</span></span><br><span class="line"><span class="comment"># remote dev env! Otherwise I&#x27;ll ssh in there and fix your code 😈</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">set</span> -eux; \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">mkdir</span> ~/.ssh; \</span></span><br><span class="line"><span class="language-bash">		curl https://github.com/fasterthanlime.keys | <span class="built_in">tee</span> -a ~/.ssh/authorized_keys</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/hello-axum ./hello-axum</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Because our top-level process starts the ssh daemon itself, for simplicity,</span></span><br><span class="line"><span class="comment"># let&#x27;s run it as root. It could drop privileges after that but we already have</span></span><br><span class="line"><span class="comment"># passwordless sudo set up on the machine so double-shrug.</span></span><br><span class="line"><span class="keyword">USER</span> root</span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;./hello-axum&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>快速之后<code>docker build -t hello-axum .</code> ，让我们再次启动它，将边缘端口 22 映射到机器端口 2222：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">fly m run -p 22:2222/tcp -r cdg -s shared-cpu-8x hello-axum</span></span><br><span class="line">(cut)</span><br></pre></td></tr></table></figure>

<p>这基本上就是全部！你现在可以停止阅读这篇文章了！</p>
<pre><code>现在？但是……你的品牌。
</code></pre>
<p>哦，我会继续的。但是你现在可以停止阅读这篇文章了。它缺少一个volume（如上所述），这意味着现在每次停止时，我们所有的数据都会消失。所以我们绝对想要那个。</p>
<p>因为我们只能有一个卷，所以我让我的“伪初始化”进程创建一个符号链接从&#x2F;var&#x2F;lib&#x2F;docker到&#x2F;home&#x2F;amos&#x2F;docker，并更改一些权限，还启动 docker 守护进程，诸如此类。</p>
<p>哦，我还在我的机器上设置了PROXY 协议处理程序，我用ppp crate解析它所以我能够记录尝试连接到我的远程开发环境的真实客户端 IP，即使这些都是 TCP 连接.</p>
<p>嗯？相对于什么？</p>
<p>好吧，如果它们是 HTTP 连接，我们将获得真正的 IP 作为标fly-client-ip 头。但是对于 TCP，实际上并没有“标头”&#x2F;“自定义元数据”的概念，因此没有 PROXY 协议。</p>
<p>哦，我并没有真正展示它：这是我退出一分钟后日志的样子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">2022-06-19T19:24:18Z proxy[e148e394a72e89] cdg [info]Machine became reachable in 12.924218ms</span><br><span class="line">2022-06-19T19:25:21Z app[e148e394a72e89] cdg [info]Connection ended gracefully (259121 bytes from client, 343897 bytes from server)</span><br><span class="line">2022-06-19T19:25:22Z app[e148e394a72e89] cdg [info]Idle for 5.001673407s</span><br><span class="line">2022-06-19T19:25:27Z app[e148e394a72e89] cdg [info]Idle for 10.002938289s</span><br><span class="line">2022-06-19T19:25:32Z app[e148e394a72e89] cdg [info]Idle for 15.004794068s</span><br><span class="line">2022-06-19T19:25:37Z app[e148e394a72e89] cdg [info]Idle for 20.005997194s</span><br><span class="line">2022-06-19T19:25:42Z app[e148e394a72e89] cdg [info]Idle for 25.00744559s</span><br><span class="line">2022-06-19T19:25:47Z app[e148e394a72e89] cdg [info]Idle for 30.008603681s</span><br><span class="line">2022-06-19T19:25:52Z app[e148e394a72e89] cdg [info]Idle for 35.009784886s</span><br><span class="line">2022-06-19T19:25:57Z app[e148e394a72e89] cdg [info]Idle for 40.010062697s</span><br><span class="line">2022-06-19T19:26:02Z app[e148e394a72e89] cdg [info]Idle for 45.011428658s</span><br><span class="line">2022-06-19T19:26:07Z app[e148e394a72e89] cdg [info]Idle for 50.012635341s</span><br><span class="line">2022-06-19T19:26:12Z app[e148e394a72e89] cdg [info]Idle for 55.013845891s</span><br><span class="line">2022-06-19T19:26:17Z app[e148e394a72e89] cdg [info]Idle for 60.014006722s</span><br><span class="line">2022-06-19T19:26:17Z app[e148e394a72e89] cdg [info]Stopping machine. Goodbye!</span><br></pre></td></tr></table></figure>

<pre><code>好酷！好像我们的工作在这里完成了？然而你想继续，不知何故？
</code></pre>
<p>嗯，是的，因为看，如果我从业余微基准测试中学到了一件事，那就是在编程语言之间进行废话比较……</p>
<pre><code>盐。上帝啊，只要签署阿莫斯。
</code></pre>
<p>…是系统调用不好。或者慢。任何。现在我们做了一堆系统调用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ e148e394a72e89% sudo strace -ff -p $(pidof hello-axum) 2&gt;&amp;1 | head -30</span><br><span class="line">strace: Process 586 attached with 9 threads</span><br><span class="line">[pid   599] futex(0x7f8ece5a9608, FUTEX_WAIT_PRIVATE, 1, NULL &lt;unfinished ...&gt;</span><br><span class="line">[pid   598] epoll_wait(3,  &lt;unfinished ...&gt;</span><br><span class="line">[pid   597] futex(0x7f8ece9b7608, FUTEX_WAIT_PRIVATE, 1, NULL &lt;unfinished ...&gt;</span><br><span class="line">[pid   596] futex(0x7f8ecebbb608, FUTEX_WAIT_PRIVATE, 1, NULL &lt;unfinished ...&gt;</span><br><span class="line">[pid   595] futex(0x7f8ecedbc608, FUTEX_WAIT_PRIVATE, 1, NULL &lt;unfinished ...&gt;</span><br><span class="line">[pid   594] futex(0x7f8ecefbd608, FUTEX_WAIT_PRIVATE, 1, NULL &lt;unfinished ...&gt;</span><br><span class="line">[pid   593] futex(0x7f8ecf1be608, FUTEX_WAIT_PRIVATE, 1, NULL &lt;unfinished ...&gt;</span><br><span class="line">[pid   592] futex(0x7f8ecf3bf608, FUTEX_WAIT_PRIVATE, 1, NULL &lt;unfinished ...&gt;</span><br><span class="line">[pid   586] futex(0x7f8ecf3c1448, FUTEX_WAIT_PRIVATE, 1, NULL &lt;unfinished ...&gt;</span><br><span class="line">[pid   598] &lt;... epoll_wait resumed&gt;[&#123;EPOLLIN|EPOLLOUT, &#123;u32=16777219, u64=16777219&#125;&#125;], 1024, 336) = 1</span><br><span class="line">[pid   598] recvfrom(12, &quot;\30\317\332\271\354+\345:\3231\223\330\303\333x\177\347%\332[\316\241\235\307\277\200\34~\322\262s\337&quot;..., 8192, 0, NULL, NULL) = 196</span><br><span class="line">[pid   598] sendto(11, &quot;\30\317\332\271\354+\345:\3231\223\330\303\333x\177\347%\332[\316\241\235\307\277\200\34~\322\262s\337&quot;..., 196, MSG_NOSIGNAL, NULL, 0) = 196</span><br><span class="line">[pid   598] recvfrom(12, 0x7f8ea4002c30, 8192, 0, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">[pid   598] epoll_wait(3, [&#123;EPOLLIN|EPOLLOUT, &#123;u32=16777219, u64=16777219&#125;&#125;], 1024, 334) = 1</span><br><span class="line">[pid   598] recvfrom(12, &quot;\306\214e\204\242x,\315\34\3427\7\241&#123;I\23f\251\321\235\36\262\35#V\372\246\344\277S\4\337&quot;..., 8192, 0, NULL, NULL) = 212</span><br><span class="line">[pid   598] sendto(11, &quot;\306\214e\204\242x,\315\34\3427\7\241&#123;I\23f\251\321\235\36\262\35#V\372\246\344\277S\4\337&quot;..., 212, MSG_NOSIGNAL, NULL, 0) = 212</span><br><span class="line">[pid   598] recvfrom(12, 0x7f8ea4002c30, 8192, 0, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">[pid   598] epoll_wait(3, [&#123;EPOLLIN|EPOLLOUT, &#123;u32=16777219, u64=16777219&#125;&#125;], 1024, 333) = 1</span><br><span class="line">[pid   598] recvfrom(12, &quot;K\223\332\24h\346#N\37\234t\364-\326\v\221p\320\254\363m&lt;\323\254\206\32\250&#x27;\362\346\207\246&quot;..., 8192, 0, NULL, NULL) = 180</span><br><span class="line">[pid   598] sendto(11, &quot;K\223\332\24h\346#N\37\234t\364-\326\v\221p\320\254\363m&lt;\323\254\206\32\250&#x27;\362\346\207\246&quot;..., 180, MSG_NOSIGNAL, NULL, 0) = 180</span><br><span class="line">[pid   598] recvfrom(12, 0x7f8ea4002c30, 8192, 0, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">[pid   598] epoll_wait(3, [&#123;EPOLLIN|EPOLLOUT, &#123;u32=16777219, u64=16777219&#125;&#125;], 1024, 332) = 1</span><br><span class="line">[pid   598] recvfrom(12, &quot;L\361W\16\244\r\254\244\313\360\357\6n\v\26.\362\364\2068\24\262\23\345\22\263\365z]\37\5~&quot;..., 8192, 0, NULL, NULL) = 164</span><br><span class="line">[pid   598] sendto(11, &quot;L\361W\16\244\r\254\244\313\360\357\6n\v\26.\362\364\2068\24\262\23\345\22\263\365z]\37\5~&quot;..., 164, MSG_NOSIGNAL, NULL, 0) = 164</span><br><span class="line">[pid   598] recvfrom(12, 0x7f8ea4002c30, 8192, 0, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">[pid   598] epoll_wait(3, [&#123;EPOLLIN|EPOLLOUT, &#123;u32=16777219, u64=16777219&#125;&#125;], 1024, 330) = 1</span><br><span class="line">[pid   598] recvfrom(12, &quot;\362\275LJk\200\25*\367\22\370\345\214A\317nX\32L\217;\270gX&#123;\254fZ\206sqL&quot;..., 8192, 0, NULL, NULL) = 140</span><br><span class="line">[pid   598] sendto(11, &quot;\362\275LJk\200\25*\367\22\370\345\214A\317nX\32L\217;\270gX&#123;\254fZ\206sqL&quot;..., 140, MSG_NOSIGNAL, NULL, 0) = 140</span><br><span class="line">[pid   598] recvfrom(12, 0x7f8ea4002c30, 8192, 0, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br></pre></td></tr></table></figure>

<p>我在这里只显示 30 行，但它滚动得非常快。</p>
<pre><code>我的意思是，是的。copy_bidirectional正在从套接字读取数据并复制到另一个套接字。并且还从另一个套接字读取并将其复制到第一个套接字。你期待什么？
</code></pre>
<p>没什么，没什么，这是一种非常合理的 I&#x2F;O 方式：我们有用户空间缓冲区，内核可以将数据复制到其中，也可以从中复制出来。</p>
<p>只是……我们现在有更现代的等价物。</p>
<pre><code>例如？
</code></pre>
<p>好吧，我不知道这是否可行，但让我们试一试。</p>
<h2 id="一个很棒的带有-tokio-uring-的-TCP-代理"><a href="#一个很棒的带有-tokio-uring-的-TCP-代理" class="headerlink" title="一个很棒的带有 tokio-uring 的 TCP 代理"></a>一个很棒的带有 tokio-uring 的 TCP 代理</h2><p>好吧，我希望一切顺利，因为我没有太多时间来写这篇文章了。</p>
<p>io-uring 是一种不同的 I&#x2F;O 方式。我会解释我对它的理解，让互联网纠正我。</p>
<p>所以旧的方法就是阻塞系统调用。首先你分配一个缓冲区，然后你做一个系统调用（可能通过一些 libc 包装器，比如reador write），传递你分配的缓冲区的地址（和大小），当它返回时，如果没有错误，你有缓冲区中的一些数据！</p>
<p>您可以通过拥有更多线程来扩大规模！由于每个线程都阻塞在……有更多数据可以从某个地方读取，或者写完成（它可能最终在内核缓冲区中，但这很好）。</p>
<p>然后是非阻塞 I&#x2F;O，这几乎是一样的，只是你将所有内容（文件描述符、套接字）设置为“非阻塞模式”，并且当你调用“读”和“写”时，如果它们不这样做没有立即可用的数据，如果调用“会阻塞”，它们将返回“EWOULDBLOCK”。</p>
<pre><code>但是你怎么知道什么时候调用 read &amp; write 呢？在一个循环中？
</code></pre>
<p>在一个循环中是的，但首先你注册你对一些资源“准备好”的兴趣，然后你做的唯一阻塞系统调用（从你的异步运行时）是等待下一个准备事件。（并且可能有多个事件，因为多个资源可能“同时”准备就绪）。</p>
<p>所以从一个线程你做这样的事情：</p>
<ul>
<li><p>打开a，设置为非阻塞，注册兴趣</p>
</li>
<li><p>打开b，设置为非阻塞，注册兴趣</p>
</li>
<li><p>等待下一次就绪事件</p>
</li>
<li><p>我们有准备活动！</p>
</li>
<li><p>其中之一是“a 已准备好读取”</p>
</li>
<li><p>尝试从 a 读取，它要么立即成功，要么返回 EWOULDBLOCK（如果我没记错的话，会发生虚假唤醒吗？）</p>
</li>
<li><p>等待下一次就绪事件</p>
<p>  好的，这就是普通的 tokio 所做的吗</p>
</li>
</ul>
<p>确切地。然后是 io-uring，其中你不执行“每个 I&#x2F;O 操作一个系统调用”，而是将项目提交到环形缓冲区，你可以从另一个环形缓冲区监视完成，至少我是这样认为的，我’我对细节仍然有点模糊。</p>
<pre><code>啊，所以，总体上更少的系统调用！这听起来很适合……高度并发的东西？
</code></pre>
<p>是的，我们的事情不是……我们只是在两个套接字之间进行双向复制。所以它可能甚至没有太大的改进，但是嘿，我以前从未尝试过，我们所需要的只是一个 5.11+ 内核，而且每个人总是说要尝试新东西。这是我在尝试。</p>
<p>所以我们只想添加tokio-uring：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">in</span> `hello-axum/Cargo.toml`</span><br><span class="line"></span><br><span class="line">[package]</span><br><span class="line">name = <span class="string">&quot;hello-axum&quot;</span></span><br><span class="line">version = <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line">edition = <span class="string">&quot;2021&quot;</span></span><br><span class="line"></span><br><span class="line">[dependencies]</span><br><span class="line">tokio = &#123; version = <span class="string">&quot;1.19.2&quot;</span>, features = [<span class="string">&quot;full&quot;</span>] &#125;</span><br><span class="line">tokio-uring = <span class="string">&quot;0.3.0&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::&#123;</span><br><span class="line">    process::Stdio,</span><br><span class="line">    rc::Rc,</span><br><span class="line">    sync::atomic::&#123;AtomicU64, Ordering&#125;,</span><br><span class="line">    time::&#123;Duration, Instant&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// we can still use regular tokio stuff!</span></span><br><span class="line"><span class="keyword">use</span> tokio::&#123;process::Command, time::sleep&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// but we want the uring versions of TCP sockets.</span></span><br><span class="line"><span class="keyword">use</span> tokio_uring::&#123;</span><br><span class="line">    buf::IoBuf,</span><br><span class="line">    net::&#123;TcpListener, TcpStream&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// can&#x27;t use a regular main function because we need to start a</span></span><br><span class="line"><span class="comment">// `tokio-uring` runtime, which manages both the main tokio runtime</span></span><br><span class="line"><span class="comment">// and the uring runtime.</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// nobody&#x27;s stopping us from defining our own main function though.</span></span><br><span class="line">    tokio_uring::<span class="title function_ invoke__">start</span>(<span class="title function_ invoke__">main_inner</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">main_inner</span>() &#123;</span><br><span class="line">    <span class="comment">// this is regular tokio stuff, still works fine.</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">status</span> = Command::<span class="title function_ invoke__">new</span>(<span class="string">&quot;service&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">arg</span>(<span class="string">&quot;ssh&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">arg</span>(<span class="string">&quot;start&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">stdin</span>(Stdio::<span class="title function_ invoke__">null</span>())</span><br><span class="line">        .<span class="title function_ invoke__">stdout</span>(Stdio::<span class="title function_ invoke__">inherit</span>())</span><br><span class="line">        .<span class="title function_ invoke__">stderr</span>(Stdio::<span class="title function_ invoke__">inherit</span>())</span><br><span class="line">        .<span class="title function_ invoke__">status</span>()</span><br><span class="line">        .<span class="keyword">await</span></span><br><span class="line">        .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="built_in">assert!</span>(status.<span class="title function_ invoke__">success</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">num_conns</span>: Rc&lt;AtomicU64&gt; = <span class="built_in">Default</span>::<span class="title function_ invoke__">default</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We can still spawn stuff, but with tokio_uring&#x27;s `spawn`. The future</span></span><br><span class="line">    <span class="comment">// we send doesn&#x27;t have to be `Send`, since it&#x27;s all single-threaded.</span></span><br><span class="line">    tokio_uring::<span class="title function_ invoke__">spawn</span>(&#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">num_conns</span> = num_conns.<span class="title function_ invoke__">clone</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">last_activity</span> = Instant::<span class="title function_ invoke__">now</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">move</span> &#123;</span><br><span class="line">            <span class="keyword">loop</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> num_conns.<span class="title function_ invoke__">load</span>(Ordering::SeqCst) &gt; <span class="number">0</span> &#123;</span><br><span class="line">                    last_activity = Instant::<span class="title function_ invoke__">now</span>();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">let</span> <span class="variable">idle_time</span> = last_activity.<span class="title function_ invoke__">elapsed</span>();</span><br><span class="line">                    <span class="built_in">println!</span>(<span class="string">&quot;Idle for &#123;idle_time:?&#125;&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> idle_time &gt; Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">60</span>) &#123;</span><br><span class="line">                        <span class="built_in">println!</span>(<span class="string">&quot;Stopping machine. Goodbye!&quot;</span>);</span><br><span class="line">                        std::process::<span class="title function_ invoke__">exit</span>(<span class="number">0</span>)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">5</span>)).<span class="keyword">await</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// tokio-uring&#x27;s TcpListener wants a `SocketAddr`, not a `ToAddrs` or</span></span><br><span class="line">    <span class="comment">// something, so let&#x27;s parse it ahead of time.</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">addr</span> = <span class="string">&quot;[::]:2222&quot;</span>.<span class="title function_ invoke__">parse</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// also it doesn&#x27;t return a future?</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">listener</span> = TcpListener::<span class="title function_ invoke__">bind</span>(addr).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">let</span> <span class="variable">Ok</span>((ingress, _)) = listener.<span class="title function_ invoke__">accept</span>().<span class="keyword">await</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Accepted connection&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">num_conns</span> = num_conns.<span class="title function_ invoke__">clone</span>();</span><br><span class="line">        tokio_uring::<span class="title function_ invoke__">spawn</span>(<span class="keyword">async</span> <span class="keyword">move</span> &#123;</span><br><span class="line">            <span class="comment">// same deal, we need to parse first. if you&#x27;re puzzled why there&#x27;s</span></span><br><span class="line">            <span class="comment">// no mention of `SocketAddr` anywhere, it&#x27;s inferred from what</span></span><br><span class="line">            <span class="comment">// `TcpStream::connect` wants.</span></span><br><span class="line">            <span class="keyword">let</span> <span class="variable">egress_addr</span> = <span class="string">&quot;127.0.0.2:22&quot;</span>.<span class="title function_ invoke__">parse</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">egress</span> = TcpStream::<span class="title function_ invoke__">connect</span>(egress_addr).<span class="keyword">await</span>.<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">            num_conns.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Ordering::SeqCst);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// `read` and `write` take owned buffers (more on that later), and</span></span><br><span class="line">            <span class="comment">// there&#x27;s no &quot;per-socket&quot; buffer, so they actually take `&amp;self`.</span></span><br><span class="line">            <span class="comment">// which means we don&#x27;t need to split them into a read half and a</span></span><br><span class="line">            <span class="comment">// write half like we&#x27;d normally do with &quot;regular tokio&quot;. Instead,</span></span><br><span class="line">            <span class="comment">// we can send a reference-counted version of it. also, since a</span></span><br><span class="line">            <span class="comment">// tokio-uring runtime is single-threaded, we can use `Rc` instead of</span></span><br><span class="line">            <span class="comment">// `Arc`.</span></span><br><span class="line">            <span class="keyword">let</span> <span class="variable">egress</span> = Rc::<span class="title function_ invoke__">new</span>(egress);</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">ingress</span> = Rc::<span class="title function_ invoke__">new</span>(ingress);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// We need to copy in both directions...</span></span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">from_ingress</span> = tokio_uring::<span class="title function_ invoke__">spawn</span>(<span class="title function_ invoke__">copy</span>(ingress.<span class="title function_ invoke__">clone</span>(), egress.<span class="title function_ invoke__">clone</span>()));</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">from_egress</span> = tokio_uring::<span class="title function_ invoke__">spawn</span>(<span class="title function_ invoke__">copy</span>(egress.<span class="title function_ invoke__">clone</span>(), ingress.<span class="title function_ invoke__">clone</span>()));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Stop as soon as one of them errors</span></span><br><span class="line">            <span class="keyword">let</span> <span class="variable">res</span> = tokio::try_join!(&amp;<span class="keyword">mut</span> from_ingress, &amp;<span class="keyword">mut</span> from_egress);</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Err</span>(e) = res &#123;</span><br><span class="line">                <span class="built_in">println!</span>(<span class="string">&quot;Connection error: &#123;&#125;&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Make sure the reference count drops to zero and the socket is</span></span><br><span class="line">            <span class="comment">// freed by aborting both tasks (which both hold a `Rc&lt;TcpStream&gt;`</span></span><br><span class="line">            <span class="comment">// for each direction)</span></span><br><span class="line">            from_ingress.<span class="title function_ invoke__">abort</span>();</span><br><span class="line">            from_egress.<span class="title function_ invoke__">abort</span>();</span><br><span class="line"></span><br><span class="line">            num_conns.<span class="title function_ invoke__">fetch_sub</span>(<span class="number">1</span>, Ordering::SeqCst);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">copy</span>(from: Rc&lt;TcpStream&gt;, to: Rc&lt;TcpStream&gt;) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), std::io::Error&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buf</span> = <span class="built_in">vec!</span>[<span class="number">0u8</span>; <span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        <span class="comment">// things look weird: we pass ownership of the buffer to `read`, and we get</span></span><br><span class="line">        <span class="comment">// it back, _even if there was an error_. There&#x27;s a whole trait for that,</span></span><br><span class="line">        <span class="comment">// which `Vec&lt;u8&gt;` implements!</span></span><br><span class="line">        <span class="keyword">let</span> (res, buf_read) = from.<span class="title function_ invoke__">read</span>(buf).<span class="keyword">await</span>;</span><br><span class="line">        <span class="comment">// Propagate errors, see how many bytes we read</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">n</span> = res?;</span><br><span class="line">        <span class="keyword">if</span> n == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="comment">// A read of size zero signals EOF (end of file), finish gracefully</span></span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">Ok</span>(());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The `slice` method here is implemented in an extension trait: it</span></span><br><span class="line">        <span class="comment">// returns an owned slice of our `Vec&lt;u8&gt;`, which we later turn back</span></span><br><span class="line">        <span class="comment">// into the full `Vec&lt;u8&gt;`</span></span><br><span class="line">        <span class="keyword">let</span> (res, buf_write) = to.<span class="title function_ invoke__">write</span>(buf_read.<span class="title function_ invoke__">slice</span>(..n)).<span class="keyword">await</span>;</span><br><span class="line">        res?;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Later is now, we want our full buffer back.</span></span><br><span class="line">        <span class="comment">// That&#x27;s why we declared our binding `mut` way back at the start of `copy`,</span></span><br><span class="line">        <span class="comment">// even though we moved it into the very first `TcpStream::read` call.</span></span><br><span class="line">        buf = buf_write.<span class="title function_ invoke__">into_inner</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> docker build, fly m remove –force, fly m run  …. 它有效！</p>
<p>让我们来看看我们现在拥有的系统调用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">59185369a43383% sudo strace -ff -p $(pidof hello-axum) 2&gt;&amp;1 | head -30</span><br><span class="line">strace: Process 584 attached with 3 threads</span><br><span class="line">[pid   584] epoll_wait(3, 0x56361d15d240, 1024, 951) = -1 EINTR (Interrupted system call)</span><br><span class="line">[pid   584] epoll_wait(3, [&#123;EPOLLIN|EPOLLOUT, &#123;u32=1, u64=1&#125;&#125;], 1024, 947) = 1</span><br><span class="line">[pid   584] write(4, &quot;\1\0\0\0\0\0\0\0&quot;, 8) = 8</span><br><span class="line">[pid   584] io_uring_enter(9, 1, 0, 0, NULL, 128) = 1</span><br><span class="line">[pid   584] epoll_wait(3, [&#123;EPOLLIN, &#123;u32=2147483648, u64=2147483648&#125;&#125;, &#123;EPOLLIN|EPOLLOUT, &#123;u32=1, u64=1&#125;&#125;], 1024, 946) = 2</span><br><span class="line">[pid   584] write(4, &quot;\1\0\0\0\0\0\0\0&quot;, 8) = 8</span><br><span class="line">[pid   584] io_uring_enter(9, 1, 0, 0, NULL, 128) = 1</span><br><span class="line">[pid   584] epoll_wait(3, [&#123;EPOLLIN, &#123;u32=2147483648, u64=2147483648&#125;&#125;], 1024, 946) = 1</span><br><span class="line">[pid   584] epoll_wait(3, 0x56361d15d240, 1024, 946) = -1 EINTR (Interrupted system call)</span><br><span class="line">[pid   584] epoll_wait(3, [&#123;EPOLLIN|EPOLLOUT, &#123;u32=1, u64=1&#125;&#125;], 1024, 945) = 1</span><br><span class="line">[pid   584] write(4, &quot;\1\0\0\0\0\0\0\0&quot;, 8) = 8</span><br><span class="line">[pid   584] io_uring_enter(9, 1, 0, 0, NULL, 128) = 1</span><br><span class="line">[pid   584] epoll_wait(3, [&#123;EPOLLIN, &#123;u32=2147483648, u64=2147483648&#125;&#125;, &#123;EPOLLIN|EPOLLOUT, &#123;u32=1, u64=1&#125;&#125;], 1024, 945) = 2</span><br><span class="line">[pid   584] write(4, &quot;\1\0\0\0\0\0\0\0&quot;, 8) = 8</span><br><span class="line">[pid   584] io_uring_enter(9, 1, 0, 0, NULL, 128) = 1</span><br><span class="line">[pid   584] epoll_wait(3, [&#123;EPOLLIN, &#123;u32=2147483648, u64=2147483648&#125;&#125;], 1024, 943) = 1</span><br><span class="line">[pid   584] epoll_wait(3, 0x56361d15d240, 1024, 943) = -1 EINTR (Interrupted system call)</span><br><span class="line">[pid   584] epoll_wait(3, [&#123;EPOLLIN|EPOLLOUT, &#123;u32=1, u64=1&#125;&#125;], 1024, 943) = 1</span><br><span class="line">[pid   584] write(4, &quot;\1\0\0\0\0\0\0\0&quot;, 8) = 8</span><br><span class="line">[pid   584] io_uring_enter(9, 1, 0, 0, NULL, 128) = 1</span><br><span class="line">[pid   584] epoll_wait(3, [&#123;EPOLLIN, &#123;u32=2147483648, u64=2147483648&#125;&#125;, &#123;EPOLLIN|EPOLLOUT, &#123;u32=1, u64=1&#125;&#125;], 1024, 943) = 2</span><br><span class="line">[pid   584] write(4, &quot;\1\0\0\0\0\0\0\0&quot;, 8) = 8</span><br><span class="line">[pid   584] io_uring_enter(9, 1, 0, 0, NULL, 128) = 1</span><br><span class="line">[pid   584] epoll_wait(3, [&#123;EPOLLIN, &#123;u32=2147483648, u64=2147483648&#125;&#125;], 1024, 943) = 1</span><br><span class="line">[pid   584] epoll_wait(3, 0x56361d15d240, 1024, 943) = -1 EINTR (Interrupted system call)</span><br><span class="line">[pid   584] epoll_wait(3, [&#123;EPOLLIN|EPOLLOUT, &#123;u32=1, u64=1&#125;&#125;], 1024, 942) = 1</span><br><span class="line">[pid   584] write(4, &quot;\1\0\0\0\0\0\0\0&quot;, 8) = 8</span><br><span class="line">[pid   584] io_uring_enter(9, 1, 0, 0, NULL, 128) = 1</span><br><span class="line">[pid   584] epoll_wait(3, [&#123;EPOLLIN, &#123;u32=2147483648, u64=2147483648&#125;&#125;, &#123;EPOLLIN|EPOLLOUT, &#123;u32=1, u64=1&#125;&#125;], 1024, 941) = 2</span><br></pre></td></tr></table></figure>

<p>好吧，我io_uring_enter在里面看到了，所以iouring肯定生效了，但它仍然在快速滚动。</p>
<pre><code>阿莫斯？
</code></pre>
<p>酷熊</p>
<pre><code>你认为 strace 的输出被发送到哪里？
</code></pre>
<p>好吧，到我的终端。我正看着它。<br>哦。啊啊啊啊啊啊对了。随着 strace 输出更多的数据，它通过 SSH 发送回给我，这导致更多的系统调用，这导致更多的 strace 输出，这导致更多的数据通过 SSH 发送回给我，这……</p>
<p>好吧，如果我们真的想在不中断 hello-axum 操作的情况下窥探（猜猜现在谁后悔选择那个名字了！），我们可能想通过 hallpass 连接：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">fly ssh console</span><br><span class="line">Connecting to top1.nearest.of.axum-machine.internal... complete</span><br><span class="line"># bash</span><br><span class="line">root@59185369a43383:/# strace -p $(pidof hello-axum) -ff</span><br><span class="line">strace: Process 584 attached with 3 threads</span><br><span class="line">[pid   584] epoll_wait(3, [], 1024, 565) = 0</span><br><span class="line">[pid   584] epoll_wait(3, [], 1024, 21) = 0</span><br><span class="line">[pid   584] write(4, &quot;\1\0\0\0\0\0\0\0&quot;, 8) = 8</span><br><span class="line">[pid   584] write(4, &quot;\1\0\0\0\0\0\0\0&quot;, 8) = 8</span><br><span class="line">[pid   584] epoll_wait(3, [&#123;EPOLLIN, &#123;u32=2147483648, u64=2147483648&#125;&#125;], 1024, 2536) = 1</span><br><span class="line">[pid   584] epoll_wait(3, [], 1024, 2536) = 0</span><br><span class="line">[pid   584] epoll_wait(3, [], 1024, 2430) = 0</span><br><span class="line">[pid   584] epoll_wait(3, [], 1024, 30) = 0</span><br><span class="line">[pid   584] write(4, &quot;\1\0\0\0\0\0\0\0&quot;, 8) = 8</span><br><span class="line">[pid   584] write(4, &quot;\1\0\0\0\0\0\0\0&quot;, 8) = 8</span><br><span class="line">[pid   584] epoll_wait(3, [&#123;EPOLLIN, &#123;u32=2147483648, u64=2147483648&#125;&#125;], 1024, 1631) = 1</span><br><span class="line">[pid   584] epoll_wait(3, [], 1024, 1631) = 0</span><br><span class="line">[pid   584] epoll_wait(3, </span><br></pre></td></tr></table></figure>

<p>更好的！现在我们只看到 SSH keepalives（通过ClientAliveInterval那里设置，你的浏览器有搜索功能我相信你），以及 vscode 和 vscode 服务器之间交换的任何聊天信息。</p>
<pre><code>好的，现在我们的工作完成了。对吗？
</code></pre>
<p>Mhhhhhhhh 可以这样说，是的。但我们仍在进行一些系统调用。你知道什么比某些系统调用更好吗？</p>
<pre><code>没有系统调用？
</code></pre>
<h2 id="一个带有-aya-的-eBPF-东西"><a href="#一个带有-aya-的-eBPF-东西" class="headerlink" title="一个带有 aya 的 eBPF 东西"></a>一个带有 aya 的 eBPF 东西</h2><p>酷熊你看，我们实际上从来没有对我们来回代理的数据做任何有用的事情。这不像我们在做 HTTP，或者如果我们自己是SSH 服务器。</p>
<p>我们只是充当管道，在两个方向上来回复制内容。</p>
<p>起初我考虑过使用像 的系统调用splice，但我意识到，这甚至比 io-uring 更进一步。splice就我而言，io-uring 解决方案更通用，可以完全替代。</p>
<p>我们真正需要做的就是知道是否有数据包发送到&#x2F;来自 OpenSSH 的端口。如果有：我们有活动，我们熬夜吧！如果没有，我们去睡觉吧。</p>
<p>您知道什么是窥探网络流量的好方法吗？</p>
<pre><code>是不是。。在标题里？是 BPF 吗？
</code></pre>
<p>是的！或者 eBPF，如果你想吹毛求疵，但请放心，我短期内没有学习 经典 BPF 的计划。</p>
<p>所以！让我们开始吧。我们实际上需要两个程序：</p>
<ul>
<li>一个 BPF 程序，我们将为 BPF 目标编译和链接（它最终将成为 ELF 文件中的字节码）</li>
<li>一个常规的 Linux 可执行文件，负责加载我们的 BPF 程序并将其附加到网络接口。<br>那么让我们创建一个新项目：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cd hello-axum/</span><br><span class="line">$ cargo new flyremote-bpf</span><br><span class="line">     Created binary (application) `flyremote-bpf` package</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<p>添加几个依赖项：</p>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># in `hello-axum/flyremote-bpf/Cargo.toml`</span></span><br><span class="line"></span><br><span class="line"><span class="section">[package]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;flyremote-bpf&quot;</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line"><span class="attr">edition</span> = <span class="string">&quot;2021&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># these are important too!</span></span><br><span class="line"><span class="section">[profile.release]</span></span><br><span class="line"><span class="attr">lto</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">panic</span> = <span class="string">&quot;abort&quot;</span></span><br><span class="line"><span class="attr">codegen-units</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">aya-bpf</span> = &#123; git = <span class="string">&quot;https://github.com/aya-rs/aya&quot;</span>, branch = <span class="string">&quot;main&quot;</span> &#125;</span><br><span class="line"><span class="attr">aya-log-ebpf</span> = &#123; git = <span class="string">&quot;https://github.com/aya-rs/aya-log&quot;</span>, branch = <span class="string">&quot;main&quot;</span> &#125;</span><br></pre></td></tr></table></figure>

<p>确保我们为此使用 nightly Rust：</p>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># in `hello-axum/flyremote-bpf/rust-toolchain.toml`</span></span><br><span class="line"></span><br><span class="line"><span class="section">[toolchain]</span></span><br><span class="line"><span class="attr">channel</span>=<span class="string">&quot;nightly&quot;</span></span><br></pre></td></tr></table></figure>

<p>有许多不同的 BPF 程序类型。我们可以查看 通过接口的每个数据包（并弄乱它们），但在这里我们真的只需要监听一些事件：什么时候刚刚建立连接？什么时候关闭的？当然，在什么地址&#x2F;端口上。</p>
<p>这是一个很好的起点：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in `hello-axum/flyremote-bpf/src/main.rs`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// We won&#x27;t have an allocator, so we can&#x27;t bring the Rust standard library</span></span><br><span class="line"><span class="comment">// with us here. Besides, it probably wouldn&#x27;t pass the BPF verifier.</span></span><br><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"><span class="meta">#![no_main]</span></span><br><span class="line"><span class="keyword">use</span> aya_bpf::&#123;macros::sock_ops, programs::SockOpsContext&#125;;</span><br><span class="line"><span class="comment">// This works a little like `tracing`!</span></span><br><span class="line"><span class="keyword">use</span> aya_log_ebpf::info;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The proc macro here does the heavy lifting. There&#x27;s a bunch of linker fuckery</span></span><br><span class="line"><span class="comment">// at hand here that would be fascinating, but that I won&#x27;t get into.</span></span><br><span class="line"><span class="meta">#[sock_ops(name = <span class="string">&quot;flyremote&quot;</span>)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">flyremote</span>(ctx: SockOpsContext) <span class="punctuation">-&gt;</span> <span class="type">u32</span> &#123;</span><br><span class="line">    <span class="keyword">match</span> <span class="keyword">unsafe</span> &#123; <span class="title function_ invoke__">try_flyremote</span>(ctx) &#125; &#123;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(ret) =&gt; ret,</span><br><span class="line">        <span class="title function_ invoke__">Err</span>(ret) =&gt; ret,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This gets called for every &quot;socket operation&quot; event.</span></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">try_flyremote</span>(ctx: SockOpsContext) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">u32</span>, <span class="type">u32</span>&gt; &#123;</span><br><span class="line">    <span class="comment">// transmuting from a `u32` to a `[u8; 4]` - should be okay.</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">local_ip4</span>: [<span class="type">u8</span>; <span class="number">4</span>] = core::mem::<span class="title function_ invoke__">transmute</span>([ctx.<span class="title function_ invoke__">local_ip4</span>()]);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">remote_ip4</span>: [<span class="type">u8</span>; <span class="number">4</span>] = core::mem::<span class="title function_ invoke__">transmute</span>([ctx.<span class="title function_ invoke__">remote_ip4</span>()]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// log some stuff</span></span><br><span class="line">    info!(</span><br><span class="line">        &amp;ctx,</span><br><span class="line">        <span class="string">&quot;op (&#123;&#125; &#123;&#125;), local port &#123;&#125;, remote port &#123;&#125;, local ip4 = &#123;&#125;.&#123;&#125;.&#123;&#125;.&#123;&#125; remote ip4 = &#123;&#125;.&#123;&#125;.&#123;&#125;.&#123;&#125;&quot;</span>,</span><br><span class="line">        <span class="title function_ invoke__">op_name</span>(ctx.<span class="title function_ invoke__">op</span>()),</span><br><span class="line">        ctx.<span class="title function_ invoke__">op</span>(),</span><br><span class="line">        ctx.<span class="title function_ invoke__">local_port</span>(),</span><br><span class="line">        <span class="comment">// this value is big-endian (but local_port is native-endian)</span></span><br><span class="line">        <span class="type">u32</span>::<span class="title function_ invoke__">from_be</span>(ctx.<span class="title function_ invoke__">remote_port</span>()),</span><br><span class="line">        local_ip4[<span class="number">0</span>],</span><br><span class="line">        local_ip4[<span class="number">1</span>],</span><br><span class="line">        local_ip4[<span class="number">2</span>],</span><br><span class="line">        local_ip4[<span class="number">3</span>],</span><br><span class="line">        remote_ip4[<span class="number">0</span>],</span><br><span class="line">        remote_ip4[<span class="number">1</span>],</span><br><span class="line">        remote_ip4[<span class="number">2</span>],</span><br><span class="line">        remote_ip4[<span class="number">3</span>],</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// that&#x27;s `BPF_SOCK_OPS_STATE_CB_FLAG` - so we receive &quot;state_cb&quot; events,</span></span><br><span class="line">    <span class="comment">// when a socket changes state.</span></span><br><span class="line">    <span class="comment">// this may fail, so it returns a `Result`, but I wouldn&#x27;t know what to do</span></span><br><span class="line">    <span class="comment">// if it failed anyway.</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">_</span> = ctx.<span class="title function_ invoke__">set_cb_flags</span>(<span class="number">1</span> &lt;&lt; <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if this is a &quot;state_cb&quot; event, show the old state and new state, which</span></span><br><span class="line">    <span class="comment">// are the first two arguments (we have up to 4 arguments)</span></span><br><span class="line">    <span class="keyword">if</span> ctx.<span class="title function_ invoke__">op</span>() == <span class="number">10</span> &#123;</span><br><span class="line">        info!(</span><br><span class="line">            &amp;ctx,</span><br><span class="line">            <span class="string">&quot;state transition: &#123;&#125; &#123;&#125; =&gt; &#123;&#125; &#123;&#125;&quot;</span>,</span><br><span class="line">            ctx.<span class="title function_ invoke__">arg</span>(<span class="number">0</span>),</span><br><span class="line">            <span class="title function_ invoke__">state_name</span>(ctx.<span class="title function_ invoke__">arg</span>(<span class="number">0</span>)),</span><br><span class="line">            ctx.<span class="title function_ invoke__">arg</span>(<span class="number">1</span>),</span><br><span class="line">            <span class="title function_ invoke__">state_name</span>(ctx.<span class="title function_ invoke__">arg</span>(<span class="number">1</span>)),</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// gleaned from `bpf.h`</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">op_name</span>(op: <span class="type">u32</span>) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span> &#123;</span><br><span class="line">    <span class="keyword">match</span> op &#123;</span><br><span class="line">        <span class="number">0</span> =&gt; <span class="string">&quot;void&quot;</span>,</span><br><span class="line">        <span class="number">1</span> =&gt; <span class="string">&quot;timeout_init&quot;</span>,</span><br><span class="line">        <span class="number">2</span> =&gt; <span class="string">&quot;rwnd_init&quot;</span>,</span><br><span class="line">        <span class="number">3</span> =&gt; <span class="string">&quot;tcp_connect_cb&quot;</span>,</span><br><span class="line">        <span class="number">4</span> =&gt; <span class="string">&quot;active_established_cb&quot;</span>,</span><br><span class="line">        <span class="number">5</span> =&gt; <span class="string">&quot;passive_established_cb&quot;</span>,</span><br><span class="line">        <span class="number">6</span> =&gt; <span class="string">&quot;needs_ecn&quot;</span>,</span><br><span class="line">        <span class="number">7</span> =&gt; <span class="string">&quot;base_rtt&quot;</span>,</span><br><span class="line">        <span class="number">8</span> =&gt; <span class="string">&quot;rto_cb&quot;</span>,</span><br><span class="line">        <span class="number">9</span> =&gt; <span class="string">&quot;retrans_cb&quot;</span>,</span><br><span class="line">        <span class="number">10</span> =&gt; <span class="string">&quot;state_cb&quot;</span>,</span><br><span class="line">        _ =&gt; <span class="string">&quot;unknown&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// gleaned from `bpf.h` too</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">state_name</span>(op: <span class="type">u32</span>) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span> &#123;</span><br><span class="line">    <span class="keyword">match</span> op &#123;</span><br><span class="line">        <span class="number">1</span> =&gt; <span class="string">&quot;established&quot;</span>,</span><br><span class="line">        <span class="number">2</span> =&gt; <span class="string">&quot;syn-sent&quot;</span>,</span><br><span class="line">        <span class="number">3</span> =&gt; <span class="string">&quot;syn-recv&quot;</span>,</span><br><span class="line">        <span class="number">4</span> =&gt; <span class="string">&quot;fin-wait1&quot;</span>,</span><br><span class="line">        <span class="number">5</span> =&gt; <span class="string">&quot;fin-wait2&quot;</span>,</span><br><span class="line">        <span class="number">6</span> =&gt; <span class="string">&quot;time-wait&quot;</span>,</span><br><span class="line">        <span class="number">7</span> =&gt; <span class="string">&quot;close&quot;</span>,</span><br><span class="line">        <span class="number">8</span> =&gt; <span class="string">&quot;close-wait&quot;</span>,</span><br><span class="line">        <span class="number">9</span> =&gt; <span class="string">&quot;last-ack&quot;</span>,</span><br><span class="line">        <span class="number">10</span> =&gt; <span class="string">&quot;listen&quot;</span>,</span><br><span class="line">        <span class="number">11</span> =&gt; <span class="string">&quot;closing&quot;</span>,</span><br><span class="line">        <span class="number">12</span> =&gt; <span class="string">&quot;new-syn-recv&quot;</span>,</span><br><span class="line">        _ =&gt; <span class="string">&quot;unknown&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[panic_handler]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">panic</span>(_info: &amp;core::panic::PanicInfo) <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; core::hint::<span class="title function_ invoke__">unreachable_unchecked</span>() &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们现在可以使用 Rust nightly 为 BPF 目标构建它，行release构建，并要求 rustc 从头开始​​构建 libcore（libstd 的 smol 部分），因为据我所知没有预构建target：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> hello-axum/flyremote-bpf/</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cargo +nightly build --verbose --target bpfel-unknown-none -Z build-std=core --release</span></span><br><span class="line">       Fresh unicode-ident v1.0.1</span><br><span class="line">       Fresh core v0.0.0 (/home/amos/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core)</span><br><span class="line">       Fresh rustc-std-workspace-core v1.99.0 (/home/amos/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/rustc-std-workspace-core)</span><br><span class="line">       Fresh proc-macro2 v1.0.39</span><br><span class="line">       (cut)</span><br><span class="line">       Fresh aya-log-ebpf v0.1.0 (https://github.com/aya-rs/aya-log?branch=main#1b0d3da1)</span><br><span class="line">   Compiling flyremote-bpf v0.1.0 (/home/amos/bearcove/flyremote-bpf)</span><br><span class="line">     Running `rustc --crate-name flyremote_bpf --edition=2021 src/main.rs (cut.)`</span><br><span class="line">    Finished release [optimized] target(s) in 0.88s</span><br></pre></td></tr></table></figure>

<p>我们可以检查结果llvm-objdump：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">llvm-objdump -t target/bpfel-unknown-none/release/flyremote-bpf</span></span><br><span class="line"></span><br><span class="line">target/bpfel-unknown-none/release/flyremote-bpf:        file format elf64-bpf</span><br><span class="line"></span><br><span class="line">SYMBOL TABLE:</span><br><span class="line">0000000000000000 l    df *ABS*  0000000000000000 flyremote_bpf-8df4772bd494bad9</span><br><span class="line">0000000000001890 l       sockops/flyremote      0000000000000000 LBB0_30</span><br><span class="line">(cut)</span><br><span class="line">0000000000000000 g     F sockops/flyremote      0000000000002a48 flyremote</span><br><span class="line">0000000000000000 g     O maps   000000000000001c AYA_LOG_BUF</span><br><span class="line">0000000000000040 g     F .text  0000000000000058 .hidden memcpy</span><br><span class="line">000000000000001c g     O maps   000000000000001c AYA_LOGS</span><br><span class="line">0000000000000000 g     F .text  0000000000000040 .hidden memset</span><br></pre></td></tr></table></figure>

<p>要将其加载到内核中，我们需要一个常规的 Linux 可执行文件。对我们来说它将是hello-axum（现在真的很后悔这个名字，它不再是 axum 驱动的了）。</p>
<p>我们需要这些依赖项：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="keyword">in</span> `hello-axum/Cargo.toml`</span></span><br><span class="line"></span><br><span class="line">[package]</span><br><span class="line">name = &quot;hello-axum&quot;</span><br><span class="line">version = &quot;0.1.0&quot;</span><br><span class="line">edition = &quot;2021&quot;</span><br><span class="line"></span><br><span class="line">[dependencies]</span><br><span class="line">aya = &#123; version = &quot;&gt;=0.11&quot;, features=[&quot;async_tokio&quot;] &#125;</span><br><span class="line">aya-log = &quot;0.1&quot;</span><br><span class="line">clap = &#123; version = &quot;3.1&quot;, features = [&quot;derive&quot;] &#125;</span><br><span class="line">color-eyre = &quot;0.6.1&quot;</span><br><span class="line">log = &quot;0.4&quot;</span><br><span class="line">simplelog = &quot;0.12&quot;</span><br><span class="line">tokio = &#123; version = &quot;1.19.2&quot;, features = [&quot;full&quot;] &#125;</span><br></pre></td></tr></table></figure>

<p>然后：我们将字节码作为可执行文件的一部分，执行一些系统调用来加载它，获取其中程序的句柄，将其附加到默认 cgroup(&#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;unified),也要配置些日志。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in `hello-axum/src/main.rs`</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> aya::programs::SockOps;</span><br><span class="line"><span class="keyword">use</span> aya::&#123;include_bytes_aligned, Bpf&#125;;</span><br><span class="line"><span class="keyword">use</span> aya_log::BpfLogger;</span><br><span class="line"><span class="keyword">use</span> clap::Parser;</span><br><span class="line"><span class="keyword">use</span> log::info;</span><br><span class="line"><span class="keyword">use</span> simplelog::&#123;ColorChoice, ConfigBuilder, LevelFilter, TermLogger, TerminalMode&#125;;</span><br><span class="line"><span class="keyword">use</span> tokio::signal;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, Parser)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Opt</span> &#123;</span><br><span class="line">    <span class="meta">#[clap(short, long, default_value = <span class="string">&quot;/sys/fs/cgroup/unified&quot;</span>)]</span></span><br><span class="line">    cgroup_path: <span class="type">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[tokio::main]</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">main</span>() <span class="punctuation">-&gt;</span> color_eyre::<span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    color_eyre::<span class="title function_ invoke__">install</span>()?;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">opt</span> = Opt::<span class="title function_ invoke__">parse</span>();</span><br><span class="line"></span><br><span class="line">    TermLogger::<span class="title function_ invoke__">init</span>(</span><br><span class="line">        LevelFilter::<span class="built_in">Debug</span>,</span><br><span class="line">        ConfigBuilder::<span class="title function_ invoke__">new</span>()</span><br><span class="line">            .<span class="title function_ invoke__">set_target_level</span>(LevelFilter::Error)</span><br><span class="line">            .<span class="title function_ invoke__">set_location_level</span>(LevelFilter::Error)</span><br><span class="line">            .<span class="title function_ invoke__">build</span>(),</span><br><span class="line">        TerminalMode::Mixed,</span><br><span class="line">        ColorChoice::Auto,</span><br><span class="line">    )?;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">bpf</span> = Bpf::<span class="title function_ invoke__">load</span>(include_bytes_aligned!(</span><br><span class="line">        <span class="string">&quot;../flyremote-bpf/target/bpfel-unknown-none/release/flyremote-bpf&quot;</span></span><br><span class="line">    ))?;</span><br><span class="line">    BpfLogger::<span class="title function_ invoke__">init</span>(&amp;<span class="keyword">mut</span> bpf)?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">program</span>: &amp;<span class="keyword">mut</span> SockOps = bpf.<span class="title function_ invoke__">program_mut</span>(<span class="string">&quot;flyremote&quot;</span>).<span class="title function_ invoke__">unwrap</span>().<span class="title function_ invoke__">try_into</span>()?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">cgroup</span> = std::fs::File::<span class="title function_ invoke__">open</span>(opt.cgroup_path)?;</span><br><span class="line">    program.<span class="title function_ invoke__">load</span>()?;</span><br><span class="line">    program.<span class="title function_ invoke__">attach</span>(cgroup)?;</span><br><span class="line"></span><br><span class="line">    info!(<span class="string">&quot;Waiting for Ctrl-C...&quot;</span>);</span><br><span class="line">    signal::<span class="title function_ invoke__">ctrl_c</span>().<span class="keyword">await</span>?;</span><br><span class="line">    info!(<span class="string">&quot;Exiting...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在我们再次开始<code>Dockerfile</code> 工作之前，我可以尝试在我的本地机器上运行它：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ cargo run</span><br><span class="line">   Compiling hello-axum v0.1.0 (/home/amos/bearcove/hello-axum)</span><br><span class="line">    Finished dev [unoptimized + debuginfo] target(s) in 3.48s</span><br><span class="line">     Running `target/debug/hello-axum`</span><br><span class="line">09:34:56 [DEBUG] (1) aya::bpf: [/home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/aya-0.11.0/src/bpf.rs:106] [FEAT PROBE] BPF program name support: true</span><br><span class="line">09:34:56 [DEBUG] (1) aya::bpf: [/home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/aya-0.11.0/src/bpf.rs:109] [FEAT PROBE] BTF support: false</span><br><span class="line">Error: </span><br><span class="line">   0: map error</span><br><span class="line">   1: the `bpf_map_freeze` syscall failed with code -1</span><br><span class="line">   2: Operation not permitted (os error 1)</span><br><span class="line"></span><br><span class="line">Location:</span><br><span class="line">   src/main.rs:35</span><br><span class="line"></span><br><span class="line">Backtrace omitted. Run with RUST_BACKTRACE=1 environment variable to display it.</span><br><span class="line">Run with RUST_BACKTRACE=full to include source snippets.</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>哦，呃。</p>
<pre><code>似乎你需要成为 root 才能运行它？
</code></pre>
<p>好吧……有一个非特权 BPF 这样的东西，只需要调整一些 sysctl 并重新启动，但大多数发行版默认情况下禁用它，因为它具有 复杂的安全隐患。</p>
<p>在我们的 microVM 中，这对我们来说并不重要，因为我们已经以 root 身份运行顶级进程，所以，让我们在这里也以 root 身份运行它：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ cargo build --quiet &amp;&amp; sudo ./target/debug/hello-axum </span><br><span class="line"><span class="number">09</span>:<span class="number">37</span>:<span class="number">03</span> [DEBUG] (<span class="number">1</span>) aya::bpf: [/home/amos/.cargo/registry/src/github.com-<span class="number">1</span>ecc6299db9ec823/aya-<span class="number">0.11</span>.<span class="number">0</span>/src/bpf.rs:<span class="number">106</span>] [FEAT PROBE] BPF program name support: <span class="literal">true</span></span><br><span class="line"><span class="number">09</span>:<span class="number">37</span>:<span class="number">03</span> [DEBUG] (<span class="number">1</span>) aya::bpf: [/home/amos/.cargo/registry/src/github.com-<span class="number">1</span>ecc6299db9ec823/aya-<span class="number">0.11</span>.<span class="number">0</span>/src/bpf.rs:<span class="number">109</span>] [FEAT PROBE] BTF support: <span class="literal">true</span></span><br><span class="line"><span class="number">09</span>:<span class="number">37</span>:<span class="number">03</span> [DEBUG] (<span class="number">1</span>) aya::bpf: [/home/amos/.cargo/registry/src/github.com-<span class="number">1</span>ecc6299db9ec823/aya-<span class="number">0.11</span>.<span class="number">0</span>/src/bpf.rs:<span class="number">113</span>] [FEAT PROBE] BTF func support: <span class="literal">true</span></span><br><span class="line"><span class="number">09</span>:<span class="number">37</span>:<span class="number">03</span> [DEBUG] (<span class="number">1</span>) aya::bpf: [/home/amos/.cargo/registry/src/github.com-<span class="number">1</span>ecc6299db9ec823/aya-<span class="number">0.11</span>.<span class="number">0</span>/src/bpf.rs:<span class="number">116</span>] [FEAT PROBE] BTF global func support: <span class="literal">true</span></span><br><span class="line"><span class="number">09</span>:<span class="number">37</span>:<span class="number">03</span> [DEBUG] (<span class="number">1</span>) aya::bpf: [/home/amos/.cargo/registry/src/github.com-<span class="number">1</span>ecc6299db9ec823/aya-<span class="number">0.11</span>.<span class="number">0</span>/src/bpf.rs:<span class="number">122</span>] [FEAT PROBE] BTF var and datasec support: <span class="literal">true</span></span><br><span class="line"><span class="number">09</span>:<span class="number">37</span>:<span class="number">03</span> [DEBUG] (<span class="number">1</span>) aya::bpf: [/home/amos/.cargo/registry/src/github.com-<span class="number">1</span>ecc6299db9ec823/aya-<span class="number">0.11</span>.<span class="number">0</span>/src/bpf.rs:<span class="number">128</span>] [FEAT PROBE] BTF float support: <span class="literal">false</span></span><br><span class="line"><span class="number">09</span>:<span class="number">37</span>:<span class="number">03</span> [DEBUG] (<span class="number">1</span>) aya::bpf: [/home/amos/.cargo/registry/src/github.com-<span class="number">1</span>ecc6299db9ec823/aya-<span class="number">0.11</span>.<span class="number">0</span>/src/bpf.rs:<span class="number">131</span>] [FEAT PROBE] BTF decl_tag support: <span class="literal">false</span></span><br><span class="line"><span class="number">09</span>:<span class="number">37</span>:<span class="number">03</span> [DEBUG] (<span class="number">1</span>) aya::bpf: [/home/amos/.cargo/registry/src/github.com-<span class="number">1</span>ecc6299db9ec823/aya-<span class="number">0.11</span>.<span class="number">0</span>/src/bpf.rs:<span class="number">134</span>] [FEAT PROBE] BTF type_tag support: <span class="literal">false</span></span><br><span class="line"><span class="number">09</span>:<span class="number">37</span>:<span class="number">04</span> [DEBUG] (<span class="number">1</span>) aya::obj::relocation: [/home/amos/.cargo/registry/src/github.com-<span class="number">1</span>ecc6299db9ec823/aya-<span class="number">0.11</span>.<span class="number">0</span>/src/obj/relocation.rs:<span class="number">270</span>] relocating program flyremote function flyremote</span><br><span class="line"><span class="number">09</span>:<span class="number">37</span>:<span class="number">04</span> [DEBUG] (<span class="number">1</span>) aya::obj::relocation: [/home/amos/.cargo/registry/src/github.com-<span class="number">1</span>ecc6299db9ec823/aya-<span class="number">0.11</span>.<span class="number">0</span>/src/obj/relocation.rs:<span class="number">327</span>] relocating call to callee address <span class="number">64</span> (relocation)</span><br><span class="line"><span class="number">09</span>:<span class="number">37</span>:<span class="number">04</span> [DEBUG] (<span class="number">1</span>) aya::obj::relocation: [/home/amos/.cargo/registry/src/github.com-<span class="number">1</span>ecc6299db9ec823/aya-<span class="number">0.11</span>.<span class="number">0</span>/src/obj/relocation.rs:<span class="number">348</span>] callee is memcpy</span><br><span class="line"><span class="number">09</span>:<span class="number">37</span>:<span class="number">04</span> [DEBUG] (<span class="number">1</span>) aya::obj::relocation: [/home/amos/.cargo/registry/src/github.com-<span class="number">1</span>ecc6299db9ec823/aya-<span class="number">0.11</span>.<span class="number">0</span>/src/obj/relocation.rs:<span class="number">270</span>] relocating program flyremote function memcpy</span><br><span class="line"><span class="number">09</span>:<span class="number">37</span>:<span class="number">04</span> [DEBUG] (<span class="number">1</span>) aya::obj::relocation: [/home/amos/.cargo/registry/src/github.com-<span class="number">1</span>ecc6299db9ec823/aya-<span class="number">0.11</span>.<span class="number">0</span>/src/obj/relocation.rs:<span class="number">363</span>] finished relocating program flyremote function memcpy</span><br><span class="line"><span class="number">09</span>:<span class="number">37</span>:<span class="number">04</span> [DEBUG] (<span class="number">1</span>) aya::obj::relocation: [/home/amos/.cargo/registry/src/github.com-<span class="number">1</span>ecc6299db9ec823/aya-<span class="number">0.11</span>.<span class="number">0</span>/src/obj/relocation.rs:<span class="number">327</span>] relocating call to callee address <span class="number">64</span> (relocation)</span><br><span class="line"><span class="number">09</span>:<span class="number">37</span>:<span class="number">04</span> [DEBUG] (<span class="number">1</span>) aya::obj::relocation: [/home/amos/.cargo/registry/src/github.com-<span class="number">1</span>ecc6299db9ec823/aya-<span class="number">0.11</span>.<span class="number">0</span>/src/obj/relocation.rs:<span class="number">348</span>] callee is memcpy</span><br><span class="line"><span class="number">09</span>:<span class="number">37</span>:<span class="number">04</span> [DEBUG] (<span class="number">1</span>) aya::obj::relocation: [/home/amos/.cargo/registry/src/github.com-<span class="number">1</span>ecc6299db9ec823/aya-<span class="number">0.11</span>.<span class="number">0</span>/src/obj/relocation.rs:<span class="number">327</span>] relocating call to callee address <span class="number">64</span> (relocation)</span><br><span class="line"><span class="number">09</span>:<span class="number">37</span>:<span class="number">04</span> [DEBUG] (<span class="number">1</span>) aya::obj::relocation: [/home/amos/.cargo/registry/src/github.com-<span class="number">1</span>ecc6299db9ec823/aya-<span class="number">0.11</span>.<span class="number">0</span>/src/obj/relocation.rs:<span class="number">348</span>] callee is memcpy</span><br><span class="line"><span class="number">09</span>:<span class="number">37</span>:<span class="number">04</span> [DEBUG] (<span class="number">1</span>) aya::obj::relocation: [/home/amos/.cargo/registry/src/github.com-<span class="number">1</span>ecc6299db9ec823/aya-<span class="number">0.11</span>.<span class="number">0</span>/src/obj/relocation.rs:<span class="number">363</span>] finished relocating program flyremote function flyremote</span><br><span class="line"><span class="number">09</span>:<span class="number">37</span>:<span class="number">04</span> [INFO] hello_axum: [src/main.rs:<span class="number">44</span>] Waiting <span class="keyword">for</span> <span class="title class_">Ctrl</span>-C..</span><br></pre></td></tr></table></figure>

<p>该程序等待新的 sockops 事件。我有一个 SSH 服务器在 127.0.0.2 端口 22 上运行，所以如果我尝试从另一个选项卡连接到它：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ssh 127.0.0.2</span><br><span class="line">(omitted: fingerprint stuff, etc.)</span><br></pre></td></tr></table></figure>

<p>…我们看：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">09:38:52 [INFO] flyremote_bpf: [src/main.rs:26] op (tcp_connect_cb 3), local port 59920, remote port 22, local ip4 = 127.0.0.1 remote ip4 = 127.0.0.2</span><br><span class="line">09:38:52 [INFO] flyremote_bpf: [src/main.rs:26] op (rwnd_init 2), local port 59920, remote port 22, local ip4 = 127.0.0.1 remote ip4 = 127.0.0.2</span><br><span class="line">09:38:52 [INFO] flyremote_bpf: [src/main.rs:26] op (timeout_init 1), local port 59920, remote port 22, local ip4 = 127.0.0.1 remote ip4 = 127.0.0.2</span><br><span class="line">09:38:52 [INFO] flyremote_bpf: [src/main.rs:26] op (needs_ecn 6), local port 59920, remote port 22, local ip4 = 127.0.0.1 remote ip4 = 127.0.0.2</span><br><span class="line">09:38:52 [INFO] flyremote_bpf: [src/main.rs:26] op (rwnd_init 2), local port 22, remote port 59920, local ip4 = 127.0.0.2 remote ip4 = 127.0.0.1</span><br><span class="line">09:38:52 [INFO] flyremote_bpf: [src/main.rs:26] op (timeout_init 1), local port 22, remote port 59920, local ip4 = 127.0.0.2 remote ip4 = 127.0.0.1</span><br><span class="line">09:38:52 [INFO] flyremote_bpf: [src/main.rs:26] op (needs_ecn 6), local port 22, remote port 59920, local ip4 = 127.0.0.2 remote ip4 = 127.0.0.1</span><br><span class="line">09:38:52 [INFO] flyremote_bpf: [src/main.rs:26] op (state_cb 10), local port 59920, remote port 22, local ip4 = 127.0.0.1 remote ip4 = 127.0.0.2</span><br><span class="line">09:38:52 [INFO] flyremote_bpf: [src/main.rs:52] state transition: 2 syn-sent =&gt; 1 established</span><br><span class="line">09:38:52 [INFO] flyremote_bpf: [src/main.rs:26] op (active_established_cb 4), local port 59920, remote port 22, local ip4 = 127.0.0.1 remote ip4 = 127.0.0.2</span><br><span class="line">09:38:52 [INFO] flyremote_bpf: [src/main.rs:26] op (passive_established_cb 5), local port 22, remote port 59920, local ip4 = 127.0.0.2 remote ip4 = 127.0.0.1</span><br><span class="line">09:38:52 [INFO] flyremote_bpf: [src/main.rs:26] op (state_cb 10), local port 22, remote port 59920, local ip4 = 127.0.0.2 remote ip4 = 127.0.0.1</span><br><span class="line">09:38:52 [INFO] flyremote_bpf: [src/main.rs:52] state transition: 3 syn-recv =&gt; 1 established</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>请注意，我们在这里看到“客户端”和“服务器”套接字都已建立，因为我是从本地主机连接的。</p>
<p>客户端套接字从到127.0.0.1:59920（127.0.0.2:22SSH 服务器所在的位置），而服务器套接字从127.0.0.2:22到 127.0.0.1:59920，恰恰相反。tcp_connect_cb仅用于“传出”连接，最终我们得到一个active_established_cb. 对于另一个方向，我们最终有一个passive_established_cb.</p>
<p>因此，对于我们的实际程序，我们希望passive_established_cb 使用本地端口 22 进行监视。</p>
<p>当我断开连接时，我们得到这个：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">09:38:56 [INFO] flyremote_bpf: [src/main.rs:26] op (state_cb 10), local port 59920, remote port 22, local ip4 = 127.0.0.1 remote ip4 = 127.0.0.2</span><br><span class="line">09:38:56 [INFO] flyremote_bpf: [src/main.rs:52] state transition: 1 established =&gt; 4 fin-wait1</span><br><span class="line">09:38:56 [INFO] flyremote_bpf: [src/main.rs:26] op (state_cb 10), local port 22, remote port 59920, local ip4 = 127.0.0.2 remote ip4 = 127.0.0.1</span><br><span class="line">09:38:56 [INFO] flyremote_bpf: [src/main.rs:52] state transition: 1 established =&gt; 8 close-wait</span><br><span class="line">09:38:56 [INFO] flyremote_bpf: [src/main.rs:26] op (state_cb 10), local port 59920, remote port 22, local ip4 = 127.0.0.1 remote ip4 = 127.0.0.2</span><br><span class="line">09:38:56 [INFO] flyremote_bpf: [src/main.rs:52] state transition: 4 fin-wait1 =&gt; 5 fin-wait2</span><br><span class="line">09:38:56 [INFO] flyremote_bpf: [src/main.rs:26] op (state_cb 10), local port 59920, remote port 22, local ip4 = 127.0.0.1 remote ip4 = 127.0.0.2</span><br><span class="line">09:38:56 [INFO] flyremote_bpf: [src/main.rs:52] state transition: 5 fin-wait2 =&gt; 7 close</span><br><span class="line">09:38:56 [INFO] flyremote_bpf: [src/main.rs:26] op (state_cb 10), local port 22, remote port 59920, local ip4 = 127.0.0.2 remote ip4 = 127.0.0.1</span><br><span class="line">09:38:56 [INFO] flyremote_bpf: [src/main.rs:52] state transition: 8 close-wait =&gt; 9 last-ack</span><br><span class="line">09:38:56 [INFO] flyremote_bpf: [src/main.rs:26] op (state_cb 10), local port 22, remote port 59920, local ip4 = 127.0.0.2 remote ip4 = 127.0.0.1</span><br><span class="line">09:38:56 [INFO] flyremote_bpf: [src/main.rs:52] state transition: 9 last-ack =&gt; 7 close</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>关闭 TCP 套接字比它最初看起来要复杂得多！您可以检查 TCP 状态图，如果它没有因为遭受足够长的时间而烙印在您的大脑中。</p>
<p>这是巨大的进步，如果它在我们的 fly.io 机器上运行，我们将最终实现O(0)系统调用。</p>
<pre><code>或者我们会吗？我们不需要……查询一些状态吗？
</code></pre>
<p>是的！你认为日志记录目前如何工作？</p>
<pre><code>我不知道，这一切都被魔法过程宏隐藏了。
</code></pre>
<p>好吧，我告诉你！当我们llvm-objdump在 BPF 程序上执行时，我们看到了这些行，它们对应于导出的符号：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0000000000000000 g     O maps   000000000000001c AYA_LOG_BUF</span><br><span class="line">000000000000001c g     O maps   000000000000001c AYA_LOGS</span><br></pre></td></tr></table></figure>

<p>在我们的“驱动程序”程序中，我们有这一行：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BpfLogger::<span class="title function_ invoke__">init</span>(&amp;<span class="keyword">mut</span> bpf)?;</span><br></pre></td></tr></table></figure>

<p>我敢打赌，如果我们深入研究这个BpfLogger东西到底做了什么，我们就会得到答案：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in `aya-log/src/lib.rs`</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">BpfLogger</span> &#123;</span><br><span class="line">    <span class="comment">/// Starts reading log records created with `aya-log-ebpf` and logs them</span></span><br><span class="line">    <span class="comment">/// with the default logger. See [log::logger].</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">init</span>(bpf: &amp;<span class="keyword">mut</span> Bpf) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;BpfLogger, Error&gt; &#123;</span><br><span class="line">        BpfLogger::<span class="title function_ invoke__">init_with_logger</span>(bpf, DefaultLogger &#123;&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/// Starts reading log records created with `aya-log-ebpf` and logs them</span></span><br><span class="line">    <span class="comment">/// with the given logger.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">init_with_logger</span>&lt;T: Log + <span class="symbol">&#x27;static</span>&gt;(</span><br><span class="line">        bpf: &amp;<span class="keyword">mut</span> Bpf,</span><br><span class="line">        logger: T,</span><br><span class="line">    ) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;BpfLogger, Error&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">logger</span> = Arc::<span class="title function_ invoke__">new</span>(logger);</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">logs</span>: AsyncPerfEventArray&lt;_&gt; = bpf.<span class="title function_ invoke__">map_mut</span>(<span class="string">&quot;AYA_LOGS&quot;</span>)?.<span class="title function_ invoke__">try_into</span>()?;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> <span class="variable">cpu_id</span> <span class="keyword">in</span> <span class="title function_ invoke__">online_cpus</span>().<span class="title function_ invoke__">map_err</span>(Error::InvalidOnlineCpu)? &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buf</span> = logs.<span class="title function_ invoke__">open</span>(cpu_id, <span class="literal">None</span>)?;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">let</span> <span class="variable">log</span> = logger.<span class="title function_ invoke__">clone</span>();</span><br><span class="line">            tokio::<span class="title function_ invoke__">spawn</span>(<span class="keyword">async</span> <span class="keyword">move</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buffers</span> = (<span class="number">0</span>..<span class="number">10</span>)</span><br><span class="line">                    .<span class="title function_ invoke__">map</span>(|_| BytesMut::<span class="title function_ invoke__">with_capacity</span>(LOG_BUF_CAPACITY))</span><br><span class="line">                    .collect::&lt;<span class="type">Vec</span>&lt;_&gt;&gt;();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">loop</span> &#123;</span><br><span class="line">                    <span class="keyword">let</span> <span class="variable">events</span> = buf.<span class="title function_ invoke__">read_events</span>(&amp;<span class="keyword">mut</span> buffers).<span class="keyword">await</span>.<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">                    <span class="meta">#[allow(clippy::needless_range_loop)]</span></span><br><span class="line">                    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..events.read &#123;</span><br><span class="line">                        <span class="keyword">let</span> <span class="variable">buf</span> = &amp;<span class="keyword">mut</span> buffers[i];</span><br><span class="line">                        <span class="title function_ invoke__">log_buf</span>(buf, &amp;*log).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(BpfLogger &#123;&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>啊啊！就是它！它正在监听“性能事件数组”的变化！我想这是 BPF 程序与用户空间通信的一种方式。</p>
<pre><code>用户空间？
</code></pre>
<p>我们的“常规 Linux 可执行文件”指示内核加载我们的 BPF 程序以及将其附加到什么等等。</p>
<pre><code>啊对。
</code></pre>
<p>而且我们还了解到 aya-log 消息最多可以是 8K。有趣的。</p>
<p>所以…我想我们可以做同样的事情来在建立新连接（到端口 22）和关闭时发送消息吗？</p>
<p>让我们试试吧！</p>
<p>我们的新程序变成这样：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in `hello-axum/flyremote-bpf/src/main.rs`</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"><span class="meta">#![no_main]</span></span><br><span class="line"><span class="keyword">use</span> aya_bpf::&#123;</span><br><span class="line">    macros::&#123;map, sock_ops&#125;,</span><br><span class="line">    maps::PerfEventArray,</span><br><span class="line">    programs::SockOpsContext,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">use</span> aya_log_ebpf::info;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This is what we&#x27;ll send over our &quot;perf event array&quot;</span></span><br><span class="line"><span class="meta">#[repr(C)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">ConnectionEvent</span> &#123;</span><br><span class="line">    <span class="comment">// 1 = connected, 2 = disconnected</span></span><br><span class="line">    <span class="keyword">pub</span> action: <span class="type">u32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// We could probably make a Rust enum work here, but I don&#x27;t feel like fighting</span></span><br><span class="line"><span class="comment">// the verifier too much today.</span></span><br><span class="line"><span class="keyword">const</span> ACTION_CONNECTED: <span class="type">u32</span> = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">const</span> ACTION_DISCONNECTED: <span class="type">u32</span> = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Just like aya-log does, but this only has events we care about</span></span><br><span class="line"><span class="meta">#[map(name = <span class="string">&quot;EVENTS&quot;</span>)]</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> EVENTS: PerfEventArray&lt;ConnectionEvent&gt; =</span><br><span class="line">    PerfEventArray::&lt;ConnectionEvent&gt;::<span class="title function_ invoke__">with_max_entries</span>(<span class="number">1024</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#[sock_ops(name = <span class="string">&quot;flyremote&quot;</span>)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">flyremote</span>(ctx: SockOpsContext) <span class="punctuation">-&gt;</span> <span class="type">u32</span> &#123;</span><br><span class="line">    <span class="keyword">match</span> <span class="keyword">unsafe</span> &#123; <span class="title function_ invoke__">try_flyremote</span>(ctx) &#125; &#123;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(ret) =&gt; ret,</span><br><span class="line">        <span class="title function_ invoke__">Err</span>(ret) =&gt; ret,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">try_flyremote</span>(ctx: SockOpsContext) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">u32</span>, <span class="type">u32</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> ctx.<span class="title function_ invoke__">local_port</span>() != <span class="number">22</span> &#123;</span><br><span class="line">        <span class="comment">// don&#x27;t care if it&#x27;s not SSH-server-relevant</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Ok</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// constants gotten from `bpf.h`</span></span><br><span class="line">    <span class="keyword">const</span> OP_PASSIVE_ESTABLISHED_CB: <span class="type">u32</span> = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">const</span> OP_STATE_CB: <span class="type">u32</span> = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> STATE_CLOSE: <span class="type">u32</span> = <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">match</span> ctx.<span class="title function_ invoke__">op</span>() &#123;</span><br><span class="line">        OP_PASSIVE_ESTABLISHED_CB =&gt; &#123;</span><br><span class="line">            info!(&amp;ctx, <span class="string">&quot;Connection accepted!&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// subscribe to `state_cb` events</span></span><br><span class="line">            <span class="keyword">let</span> <span class="variable">_</span> = ctx.<span class="title function_ invoke__">set_cb_flags</span>(<span class="number">1</span> &lt;&lt; <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// notify userspace</span></span><br><span class="line">            <span class="keyword">let</span> <span class="variable">ev</span> = ConnectionEvent &#123;</span><br><span class="line">                action: ACTION_CONNECTED,</span><br><span class="line">            &#125;;</span><br><span class="line">            EVENTS.<span class="title function_ invoke__">output</span>(&amp;ctx, &amp;ev, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        OP_STATE_CB =&gt; &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">new_state</span> = ctx.<span class="title function_ invoke__">arg</span>(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> new_state == STATE_CLOSE &#123;</span><br><span class="line">                info!(&amp;ctx, <span class="string">&quot;Connection closed!&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// notify userspace</span></span><br><span class="line">                <span class="keyword">let</span> <span class="variable">ev</span> = ConnectionEvent &#123;</span><br><span class="line">                    action: ACTION_DISCONNECTED,</span><br><span class="line">                &#125;;</span><br><span class="line">                EVENTS.<span class="title function_ invoke__">output</span>(&amp;ctx, &amp;ev, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        _ =&gt; &#123;</span><br><span class="line">            <span class="comment">// ignore</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[panic_handler]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">panic</span>(_info: &amp;core::panic::PanicInfo) <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; core::hint::<span class="title function_ invoke__">unreachable_unchecked</span>() &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>多亏了aya-log。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ (cd flyremote-bpf &amp;&amp; cargo +nightly build --verbose --target bpfel-unknown-none -Z build-std=core --release)</span><br><span class="line">(cut)</span><br><span class="line">$ cargo build --quiet &amp;&amp; sudo ./target/debug/hello-<span class="title function_ invoke__">axum</span></span><br><span class="line">(cut)</span><br><span class="line"><span class="number">10</span>:<span class="number">01</span>:<span class="number">30</span> [INFO] hello_axum: [src/main.rs:<span class="number">45</span>] Waiting <span class="keyword">for</span> <span class="title class_">Ctrl</span>-C...</span><br><span class="line"><span class="number">10</span>:<span class="number">01</span>:<span class="number">36</span> [INFO] flyremote_bpf: [src/main.rs:<span class="number">49</span>] Connection accepted!</span><br><span class="line"><span class="number">10</span>:<span class="number">01</span>:<span class="number">37</span> [INFO] flyremote_bpf: [src/main.rs:<span class="number">63</span>] Connection closed!</span><br></pre></td></tr></table></figure>
<p>精彩的！现在，如果我们只订阅我们的 perf 事件数组……</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in `hello-axum/src/main.rs`</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> std::&#123;</span><br><span class="line">    fs::File,</span><br><span class="line">    sync::&#123;</span><br><span class="line">        atomic::&#123;AtomicU64, Ordering&#125;,</span><br><span class="line">        Arc,</span><br><span class="line">    &#125;,</span><br><span class="line">    time::&#123;Duration, Instant&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> aya::&#123;include_bytes_aligned, util::online_cpus, Bpf&#125;;</span><br><span class="line"><span class="keyword">use</span> aya::&#123;maps::perf::AsyncPerfEventArray, programs::SockOps&#125;;</span><br><span class="line"><span class="keyword">use</span> aya_log::BpfLogger;</span><br><span class="line"><span class="keyword">use</span> bytes::BytesMut;</span><br><span class="line"><span class="keyword">use</span> tokio::&#123;signal, time::sleep&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This is what we&#x27;ll receive over our &quot;perf event array&quot;. We&#x27;d normally</span></span><br><span class="line"><span class="comment">// have a &quot;common&quot; crate we pull from both the bpf-nostd world and the</span></span><br><span class="line"><span class="comment">// userspace-yesstd world, but for this example we&#x27;re just copying it wholesale.</span></span><br><span class="line"><span class="meta">#[repr(C)]</span></span><br><span class="line"><span class="meta">#[derive(Clone, Copy)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">ConnectionEvent</span> &#123;</span><br><span class="line">    <span class="comment">// 1 = connected, 2 = disconnected</span></span><br><span class="line">    <span class="keyword">pub</span> action: <span class="type">u32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ACTION_CONNECTED: <span class="type">u32</span> = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">const</span> ACTION_DISCONNECTED: <span class="type">u32</span> = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Because we used `repr(C)` we can treat it as POD (plain old data)</span></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span> <span class="title class_">aya</span>::Pod <span class="keyword">for</span> <span class="title class_">ConnectionEvent</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[tokio::main]</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">main</span>() <span class="punctuation">-&gt;</span> color_eyre::<span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    color_eyre::<span class="title function_ invoke__">install</span>()?;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">bpf</span> = Bpf::<span class="title function_ invoke__">load</span>(include_bytes_aligned!(</span><br><span class="line">        <span class="string">&quot;../flyremote-bpf/target/bpfel-unknown-none/release/flyremote-bpf&quot;</span></span><br><span class="line">    ))?;</span><br><span class="line">    BpfLogger::<span class="title function_ invoke__">init</span>(&amp;<span class="keyword">mut</span> bpf)?;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">num_conns</span>: Arc&lt;AtomicU64&gt; = <span class="built_in">Default</span>::<span class="title function_ invoke__">default</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">perf_array</span> = AsyncPerfEventArray::<span class="title function_ invoke__">try_from</span>(bpf.<span class="title function_ invoke__">map_mut</span>(<span class="string">&quot;EVENTS&quot;</span>)?)?;</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">cpu_id</span> <span class="keyword">in</span> <span class="title function_ invoke__">online_cpus</span>()? &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buf</span> = perf_array.<span class="title function_ invoke__">open</span>(cpu_id, <span class="literal">None</span>)?;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">num_conns</span> = num_conns.<span class="title function_ invoke__">clone</span>();</span><br><span class="line">        tokio::<span class="title function_ invoke__">spawn</span>(<span class="keyword">async</span> <span class="keyword">move</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buffers</span> = (<span class="number">0</span>..<span class="number">10</span>)</span><br><span class="line">                .<span class="title function_ invoke__">map</span>(|_| BytesMut::<span class="title function_ invoke__">with_capacity</span>(<span class="number">1024</span>))</span><br><span class="line">                .collect::&lt;<span class="type">Vec</span>&lt;_&gt;&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">loop</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">events</span> = buf.<span class="title function_ invoke__">read_events</span>(&amp;<span class="keyword">mut</span> buffers).<span class="keyword">await</span>.<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">                <span class="keyword">for</span> <span class="variable">buf</span> <span class="keyword">in</span> &amp;<span class="keyword">mut</span> buffers[..events.read] &#123;</span><br><span class="line">                    <span class="keyword">let</span> <span class="variable">ev</span> = <span class="keyword">unsafe</span> &#123; (buf.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> *<span class="keyword">const</span> ConnectionEvent).<span class="title function_ invoke__">read_unaligned</span>() &#125;;</span><br><span class="line">                    <span class="keyword">match</span> ev.action &#123;</span><br><span class="line">                        ACTION_CONNECTED =&gt; &#123;</span><br><span class="line">                            <span class="built_in">println!</span>(<span class="string">&quot;Connection accepted!&quot;</span>);</span><br><span class="line">                            num_conns.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Ordering::SeqCst);</span><br><span class="line">                        &#125;</span><br><span class="line">                        ACTION_DISCONNECTED =&gt; &#123;</span><br><span class="line">                            <span class="built_in">println!</span>(<span class="string">&quot;Connection closed!&quot;</span>);</span><br><span class="line">                            num_conns.<span class="title function_ invoke__">fetch_sub</span>(<span class="number">1</span>, Ordering::SeqCst);</span><br><span class="line">                        &#125;</span><br><span class="line">                        unknown =&gt; &#123;</span><br><span class="line">                            <span class="built_in">println!</span>(<span class="string">&quot;Unknown action: &#123;&#125;&quot;</span>, unknown);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tokio::<span class="title function_ invoke__">spawn</span>(<span class="keyword">async</span> <span class="keyword">move</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">last_activity</span> = Instant::<span class="title function_ invoke__">now</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> num_conns.<span class="title function_ invoke__">load</span>(Ordering::SeqCst) &gt; <span class="number">0</span> &#123;</span><br><span class="line">                last_activity = Instant::<span class="title function_ invoke__">now</span>();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">idle_time</span> = last_activity.<span class="title function_ invoke__">elapsed</span>();</span><br><span class="line">                <span class="built_in">println!</span>(<span class="string">&quot;Idle for &#123;idle_time:?&#125;&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> idle_time &gt; Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">60</span>) &#123;</span><br><span class="line">                    <span class="built_in">println!</span>(<span class="string">&quot;Stopping machine. Goodbye!&quot;</span>);</span><br><span class="line">                    std::process::<span class="title function_ invoke__">exit</span>(<span class="number">0</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">5</span>)).<span class="keyword">await</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">program</span>: &amp;<span class="keyword">mut</span> SockOps = bpf.<span class="title function_ invoke__">program_mut</span>(<span class="string">&quot;flyremote&quot;</span>).<span class="title function_ invoke__">unwrap</span>().<span class="title function_ invoke__">try_into</span>()?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">cgroup</span> = File::<span class="title function_ invoke__">open</span>(<span class="string">&quot;/sys/fs/cgroup/unified&quot;</span>)?;</span><br><span class="line">    program.<span class="title function_ invoke__">load</span>()?;</span><br><span class="line">    program.<span class="title function_ invoke__">attach</span>(cgroup)?;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Waiting for Ctrl-C...&quot;</span>);</span><br><span class="line">    signal::<span class="title function_ invoke__">ctrl_c</span>().<span class="keyword">await</span>?;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Exiting...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它做到了！</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ cargo build --quiet &amp;&amp; sudo ./target/debug/hello-axum</span><br><span class="line">Idle for 19.527µs</span><br><span class="line">Waiting for Ctrl-C...</span><br><span class="line">(in another terminal: ssh 127.0.0.2)</span><br><span class="line">Connection accepted!</span><br><span class="line">(in another terminal: Ctrl-D to close out of SSH)</span><br><span class="line">Connection closed!</span><br><span class="line">Idle for 5.001708865s</span><br><span class="line">Idle for 10.003602174s</span><br><span class="line">Idle for 15.004068679s</span><br><span class="line">Idle for 20.005524839s</span><br><span class="line">Idle for 25.006052848s</span><br><span class="line">Idle for 30.007529878s</span><br><span class="line">Idle for 35.008838041s</span><br><span class="line">Idle for 40.010259957s</span><br><span class="line">Idle for 45.011105232s</span><br><span class="line">Idle for 50.012581951s</span><br><span class="line">Idle for 55.013017848s</span><br><span class="line">Idle for 60.01454433s</span><br><span class="line">Stopping machine. Goodbye!</span><br></pre></td></tr></table></figure>
<pre><code>很棒。但这到底是怎么“在云端”运行的呢？
</code></pre>
<p>嗯，Bear，正如我之前所说，我已经在“云中”完成了所有这些工作。我已经在 fly.io 上的实际远程开发环境中测试了该代码。因为他们提供的内核是支持 BPF 的。这就是我知道它会起作用的方式。</p>
<p>“我们需要做的 (TM)”是在我们执行任何这些操作之前重新启动 SSH 服务器，并让它监听……假设这次是 IPv4 上的端口 2222。</p>
<pre><code>等等，我们为什么要更改端口？
</code></pre>
<p>好吧，因为我们需要倾听0.0.0.0这个时间。请记住，fly-proxy 是将“边缘端口 22”暴露给 VM 内部某个端口的代理。它实际上是通过eth0接口连接的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ ip addr show dev eth0</span><br><span class="line">3: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1420 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether de:ad:f9:57:5a:f4 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.19.0.210/29 brd 172.19.0.215 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 172.19.0.211/29 brd 172.19.0.215 scope global secondary eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 2604:1380:71:1403:0:ae09:fd49:1/127 scope global nodad </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fdaa:0:6964:a7b:5b66:ae09:fd49:2/112 scope global nodad </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::dcad:f9ff:fe57:5af4/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<p>…但我们不要依赖它。我们现在确实希望 OpenSSH 监听0.0.0.0 （“所有接口”），并且端口 22 已经被 hallpass 用于给定接口，因此绑定会失败。</p>
<p>因此，让我们改为监听端口 2222（留给读者作为练习），并确保调整我们的 BPF 程序，以便它监视与端口 2222 而不是 22 的连接（也留作练习）。</p>
<p>Dockerfile，我会帮忙。但实际上这就是我们已经完成的，只是在 Docker 中：我们只需要改下“builder”目标的最后一部分。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># in `hello-axum/Dockerfile`</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># syntax = docker/dockerfile:1.4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">################################################################################</span></span><br><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span> AS builder</span><br><span class="line"></span><br><span class="line"><span class="comment"># (omitted: install base utils, install rustup, add rustup to path)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Build some code!</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> --mount=<span class="built_in">type</span>=cache,target=/app/target \</span></span><br><span class="line"><span class="language-bash">		--mount=<span class="built_in">type</span>=cache,target=/root/.cargo/registry \</span></span><br><span class="line"><span class="language-bash">		--mount=<span class="built_in">type</span>=cache,target=/root/.cargo/git \</span></span><br><span class="line"><span class="language-bash">		--mount=<span class="built_in">type</span>=cache,target=/root/.rustup \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">set</span> -eux; \</span></span><br><span class="line"><span class="language-bash">		rustup install nightly; \</span></span><br><span class="line"><span class="language-bash">		rustup component add rust-src --toolchain nightly; \</span></span><br><span class="line"><span class="language-bash">		cargo +nightly install bpf-linker; \</span></span><br><span class="line"><span class="language-bash">		(<span class="built_in">cd</span> flyremote-bpf &amp;&amp; cargo +nightly build --verbose --target bpfel-unknown-none -Z build-std=core --release); \</span></span><br><span class="line"><span class="language-bash">	 	cargo +nightly build --release; \</span></span><br><span class="line"><span class="language-bash">		objcopy --compress-debug-sections target/release/hello-axum ./hello-axum</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (omitted: other targets)</span></span><br></pre></td></tr></table></figure>

<p>这里需要注意一点：无论如何我们都需要nightly构建 BPF 程序，所以我也选择用它来构建主程序，这样我们就不必安装两个不同的工具链。我们需要rust-src组件，所以我们添加它。这绝对是安装位bpf-linker的错误位置（我们之前想这样做 COPY . .），但你可以弄清楚这一点。</p>
<p>到现在为止，您应该知道如何强制移除旧机器并运行新机器，所以我不会展示这部分——相反，我将展示一些日志，这些日志提供了它按预期工作的不可抗拒的证据：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ fly logs</span><br><span class="line">(cut)</span><br><span class="line">2022-06-20T10:32:59Z app[73d8d463ce7589] cdg [info]Idle for 55.013385687s</span><br><span class="line">2022-06-20T10:33:04Z app[73d8d463ce7589] cdg [info]Idle for 60.014628076s</span><br><span class="line">2022-06-20T10:33:04Z app[73d8d463ce7589] cdg [info]Stopping machine. Goodbye!</span><br><span class="line">2022-06-20T10:35:09Z proxy[73d8d463ce7589] cdg [info]Machine started in 378.712588ms</span><br><span class="line">2022-06-20T10:35:09Z app[73d8d463ce7589] cdg [info] * Starting OpenBSD Secure Shell server sshd</span><br><span class="line">2022-06-20T10:35:09Z app[73d8d463ce7589] cdg [info]   ...done.</span><br><span class="line">2022-06-20T10:35:09Z app[73d8d463ce7589] cdg [info]Idle for 351ns</span><br><span class="line">2022-06-20T10:35:09Z app[73d8d463ce7589] cdg [info]Waiting for Ctrl-C...</span><br><span class="line">2022-06-20T10:35:09Z proxy[73d8d463ce7589] cdg [info]Machine became reachable in 162.022275ms</span><br><span class="line">2022-06-20T10:35:09Z app[73d8d463ce7589] cdg [info]Connection accepted!</span><br><span class="line">2022-06-20T10:35:24Z app[73d8d463ce7589] cdg [info]Connection closed!</span><br><span class="line">2022-06-20T10:35:29Z app[73d8d463ce7589] cdg [info]Idle for 5.000919043s</span><br><span class="line">2022-06-20T10:35:33Z app[73d8d463ce7589] cdg [info]Connection accepted!</span><br><span class="line">2022-06-20T10:35:37Z app[73d8d463ce7589] cdg [info]Connection closed!</span><br><span class="line">2022-06-20T10:35:39Z app[73d8d463ce7589] cdg [info]Idle for 5.001182727s</span><br><span class="line">2022-06-20T10:35:44Z app[73d8d463ce7589] cdg [info]Idle for 10.00136033s</span><br><span class="line">2022-06-20T10:35:49Z app[73d8d463ce7589] cdg [info]Idle for 15.002518752s</span><br><span class="line">2022-06-20T10:35:54Z app[73d8d463ce7589] cdg [info]Idle for 20.003763466s</span><br><span class="line">2022-06-20T10:35:59Z app[73d8d463ce7589] cdg [info]Idle for 25.00504594s</span><br><span class="line">2022-06-20T10:36:04Z app[73d8d463ce7589] cdg [info]Idle for 30.006257662s</span><br><span class="line">2022-06-20T10:36:09Z app[73d8d463ce7589] cdg [info]Idle for 35.007527924s</span><br><span class="line">2022-06-20T10:36:14Z app[73d8d463ce7589] cdg [info]Idle for 40.008764092s</span><br><span class="line">2022-06-20T10:36:19Z app[73d8d463ce7589] cdg [info]Idle for 45.010007093s</span><br><span class="line">2022-06-20T10:36:24Z app[73d8d463ce7589] cdg [info]Idle for 50.011195821s</span><br><span class="line">2022-06-20T10:36:29Z app[73d8d463ce7589] cdg [info]Idle for 55.011391438s</span><br><span class="line">2022-06-20T10:36:34Z app[73d8d463ce7589] cdg [info]Idle for 60.01265106s</span><br><span class="line">2022-06-20T10:36:34Z app[73d8d463ce7589] cdg [info]Stopping machine. Goodbye!</span><br></pre></td></tr></table></figure>

<p>啊……幸福。</p>
<pre><code>你是不是忘记了什么？
</code></pre>
<p>啊对！我们实际执行了多少系统调用？既然它是这个悲惨世界中善良的唯一衡量标准？</p>
<p>为了测试这一点，我将从 VSCode 进行连接，并运行一些不断输出文本的东西，比如……好吧，也许不是yes，但是watch whoami。</p>
<p>然后从fly ssh console，我们就跑strace…</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ strace -ff -p $(pidof hello-axum)</span><br><span class="line">strace: Process 583 attached with 9 threads</span><br><span class="line">[pid   596] futex(0x7fb0baa0d618, FUTEX_WAIT_PRIVATE, 1, NULL &lt;unfinished ...&gt;</span><br><span class="line">[pid   595] futex(0x7fb0bac11618, FUTEX_WAIT_PRIVATE, 1, NULL &lt;unfinished ...&gt;</span><br><span class="line">[pid   594] epoll_wait(3,  &lt;unfinished ...&gt;</span><br><span class="line">[pid   592] futex(0x7fb0bb21d618, FUTEX_WAIT_PRIVATE, 1, NULL &lt;unfinished ...&gt;</span><br><span class="line">[pid   591] futex(0x7fb0bb41e618, FUTEX_WAIT_PRIVATE, 1, NULL &lt;unfinished ...&gt;</span><br><span class="line">[pid   590] futex(0x7fb0bb622618, FUTEX_WAIT_PRIVATE, 1, NULL &lt;unfinished ...&gt;</span><br><span class="line">[pid   589] futex(0x7fb0bb823618, FUTEX_WAIT_PRIVATE, 1, NULL &lt;unfinished ...&gt;</span><br><span class="line">[pid   583] futex(0x7fb0bb825498, FUTEX_WAIT_PRIVATE, 1, NULL &lt;unfinished ...&gt;</span><br><span class="line">[pid   593] futex(0x7fb0bb019618, FUTEX_WAIT_PRIVATE, 1, NULL &lt;unfinished ...&gt;</span><br><span class="line">[pid   594] &lt;... epoll_wait resumed&gt;[], 1024, 1718) = 0</span><br><span class="line">[pid   594] epoll_wait(3, [], 1024, 30) = 0</span><br><span class="line">[pid   594] write(4, &quot;\1\0\0\0\0\0\0\0&quot;, 8) = 8</span><br><span class="line">[pid   594] epoll_wait(3, [&#123;EPOLLIN, &#123;u32=2147483648, u64=2147483648&#125;&#125;], 1024, 1824) = 1</span><br><span class="line">[pid   594] epoll_wait(3, [], 1024, 1824) = 0</span><br><span class="line">[pid   594] epoll_wait(3, [], 1024, 3134) = 0</span><br><span class="line">[pid   594] epoll_wait(3, [], 1024, 37) = 0</span><br><span class="line">[pid   594] write(4, &quot;\1\0\0\0\0\0\0\0&quot;, 8) = 8</span><br><span class="line">[pid   594] epoll_wait(3, [&#123;EPOLLIN, &#123;u32=2147483648, u64=2147483648&#125;&#125;], 1024, 919) = 1</span><br><span class="line">[pid   594] epoll_wait(3, [], 1024, 919) = 0</span><br><span class="line">[pid   594] epoll_wait(3,</span><br></pre></td></tr></table></figure>
<p>嗯。它非常安静。让我们尝试断开连接？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[], 1024, 2775) = 0</span><br><span class="line">[pid   594] epoll_wait(3,</span><br><span class="line">[&#123;EPOLLIN, &#123;u32=2, u64=2&#125;&#125;, &#123;EPOLLIN, &#123;u32=10, u64=10&#125;&#125;], 1024, 2173) = 2</span><br><span class="line">[pid   594] futex(0x7fb0bb823618, FUTEX_WAKE_PRIVATE, 1) = 1</span><br><span class="line">[pid   589] &lt;... futex resumed&gt;)        = 0</span><br><span class="line">[pid   594] write(1, &quot;Connection closed!\n&quot;, 19 &lt;unfinished ...&gt;</span><br><span class="line">[pid   589] futex(0x7fb0bb019618, FUTEX_WAKE_PRIVATE, 1 &lt;unfinished ...&gt;</span><br><span class="line">[pid   594] &lt;... write resumed&gt;)        = 19</span><br><span class="line">[pid   589] &lt;... futex resumed&gt;)        = 1</span><br><span class="line">[pid   593] &lt;... futex resumed&gt;)        = 0</span><br><span class="line">[pid   594] futex(0x7fb0bae15618, FUTEX_WAIT_PRIVATE, 1, NULL &lt;unfinished ...&gt;</span><br><span class="line">[pid   593] epoll_wait(3,  &lt;unfinished ...&gt;</span><br><span class="line">[pid   589] futex(0x7fb0bb823618, FUTEX_WAIT_PRIVATE, 1, NULL &lt;unfinished ...&gt;</span><br><span class="line">[pid   593] &lt;... epoll_wait resumed&gt;[], 1024, 1370) = 0</span><br><span class="line">[pid   593] epoll_wait(3, [], 1024, 49) = 0</span><br><span class="line">[pid   593] write(1, &quot;Idle for 5.001369468s\n&quot;, 22) = 22</span><br><span class="line">[pid   593] write(4, &quot;\1\0\0\0\0\0\0\0&quot;, 8) = 8</span><br><span class="line">[pid   593] epoll_wait(3, [&#123;EPOLLIN, &#123;u32=2147483648, u64=2147483648&#125;&#125;], 1024, 1869) = 1</span><br><span class="line">[pid   593] epoll_wait(3,</span><br></pre></td></tr></table></figure>
<p>现在重新连接？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[], 1024, 1869) = 0</span><br><span class="line">[pid   593] epoll_wait(3, [], 1024, 3070) = 0</span><br><span class="line">[pid   593] epoll_wait(3, [], 1024, 57) = 0</span><br><span class="line">[pid   593] write(1, &quot;Idle for 10.002899968s\n&quot;, 23) = 23</span><br><span class="line">[pid   593] write(4, &quot;\1\0\0\0\0\0\0\0&quot;, 8) = 8</span><br><span class="line">[pid   593] epoll_wait(3, [&#123;EPOLLIN, &#123;u32=2147483648, u64=2147483648&#125;&#125;], 1024, 964) = 1</span><br><span class="line">[pid   593] epoll_wait(3, [], 1024, 964) = 0</span><br><span class="line">[pid   593] epoll_wait(3, [&#123;EPOLLIN, &#123;u32=2, u64=2&#125;&#125;, &#123;EPOLLIN, &#123;u32=10, u64=10&#125;&#125;], 1024, 4031) = 2</span><br><span class="line">[pid   593] futex(0x7fb0bb823618, FUTEX_WAKE_PRIVATE, 1) = 1</span><br><span class="line">[pid   593] write(1, &quot;Connection accepted!\n&quot;, 21) = 21</span><br><span class="line">[pid   589] &lt;... futex resumed&gt;)        = 0</span><br><span class="line">[pid   593] epoll_wait(3,  &lt;unfinished ...&gt;</span><br><span class="line">[pid   589] futex(0x7fb0bb823618, FUTEX_WAIT_PRIVATE, 1, NULL</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>太厉害了。<br>    阿摩司？这不是完全矫枉过正吗？<br>哦，几乎可以肯定。我认为没有人需要那么多地优化他们的远程开发环境：我们绝对可以忍受手动将缓冲区从内核空间复制到用户空间并返回的额外开销。</p>
<p>但是我们能做到不是很酷吗？</p>
<pre><code>确实。但我的意思是...为此使用 BPF？
</code></pre>
<p>哦，是的，这也太过分了。再一次，我只是在这一点上屈服（教学，我的意思是教学）。</p>
<pre><code>是的，我想说的是……可能还有其他方法可以知道 OpenSSH 的进程有哪些连接，对吗？内核不跟踪那个吗？
</code></pre>
<p>它 100% 绝对可以，因此有一个更简单的解决方案，我们可以使用 bash 脚本来完成。</p>
<pre><code>哦哦，我们在写 bash 脚本吗？
</code></pre>
<p>哦不。不不不。今天不行。</p>
<h2 id="简单地轮询-procfs"><a href="#简单地轮询-procfs" class="headerlink" title="简单地轮询 procfs"></a>简单地轮询 procfs</h2><p>看，内核很友好，可以简单地通过 procfs 公开各种信息。所以如果你愿意阅读几个文件，你可以得到这个，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@73d8d463ce7589:/# cat &quot;/proc/$(pidof -s sshd)/net/tcp&quot;</span><br><span class="line">  sl  local_address rem_address   st tx_queue rx_queue tr tm-&gt;when retrnsmt   uid  timeout inode</span><br><span class="line">   0: 00000000:08AE 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 10244 1 000000007d0c6713 100 0 0 10 0</span><br><span class="line">   1: 0100007F:8019 00000000:0000 0A 00000000:00000000 00:00000000 00000000  1000        0 7194 1 000000000b0ca858 100 0 0 10 0</span><br><span class="line">   2: 1A0413AC:08AE 47851C93:E44A 01 00000000:00000000 02:000A7F5E 00000000     0        0 13366 2 00000000255b322e 21 4 30 10 50</span><br><span class="line">   3: 0100007F:8019 0100007F:E76C 01 00000000:00000000 00:00000000 00000000  1000        0 7682 1 000000004d3b51d2 21 4 2 10 -1</span><br><span class="line">   4: 0100007F:8019 0100007F:E76A 01 00000000:00000000 00:00000000 00000000  1000        0 7680 1 00000000eb58348a 20 4 30 10 -1</span><br><span class="line">   5: 0100007F:E76C 0100007F:8019 01 00000000:00000000 00:00000000 00000000  1000        0 13405 1 00000000d63dc6ce 21 4 18 10 -1</span><br><span class="line">   6: 0100007F:E76A 0100007F:8019 01 00000000:00000000 00:00000000 00000000  1000        0 13403 1 0000000057ff1c3b 20 4 10 10 -1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<pre><code>这是啥？
</code></pre>
<p>好吧，它是这么说的！这是一个 TCP 连接列表：有本地地址、远程地址和一些更多信息。</p>
<pre><code>好的，但是那些地址看起来……我的意思是……它们看起来有点像 MAC 地址？
</code></pre>
<p>哦不不，它们只是十六进制。因此，例如，我们现在让 sshd 在端口 2222 上侦听，以十六进制表示，是吗？</p>
<pre><code>哦，0x8AE！
</code></pre>
<p>正确！因此，这是我们的活跃链接：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@73d8d463ce7589:/# grep &quot;08AE&quot; &quot;/proc/$(pidof -s sshd)/net/tcp&quot;</span><br><span class="line">   0: 00000000:08AE 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 10244 1 000000007d0c6713 100 0 0 10 0</span><br><span class="line">   2: 1A0413AC:08AE 47851C93:E44A 01 00000000:00000000 02:000A50A1 00000000     0        0 13366 2 00000000255b322e 21 4 30 10 50</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>等等，不，有两个。</p>
<pre><code>啊，也许第一个是监听套接字？
</code></pre>
<p>大概！这似乎是正确的，因为它对一堆字段具有全零值。</p>
<p>事实上，让我们尝试断开连接…</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@73d8d463ce7589:/# grep &quot;08AE&quot; &quot;/proc/$(pidof -s sshd)/net/tcp&quot;</span><br><span class="line">   0: 00000000:08AE 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 10244 1 000000007d0c6713 100 0 0 10 0</span><br></pre></td></tr></table></figure>

<p>是的！听起来不错。</p>
<pre><code>好的，我现在明白你对 bash 脚本的意思了。因为它只是一个文件，我们可以喜欢... grep for 08AE，排除那些00000000东西，然后有一个计数器来跟踪没有连接的时间...然后如果已经有一段时间就退出...
</code></pre>
<p>是的，因为 bash 在字符串和数字（​​不要@我）、时间和条件，事实上一切方面都非常糟糕，而且因为有一个整洁的 procfs crate，而且因为这仍然是我的博客，我仍然制作规则在这里，我只是要写 Rust。</p>
<p>让我们开始吧：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ cargo add procfs</span><br><span class="line">    Updating &#x27;https://github.com/rust-lang/crates.io-index&#x27; index</span><br><span class="line">      Adding procfs v0.12.0 to dependencies.</span><br><span class="line">             Features:</span><br><span class="line">             + chrono</span><br><span class="line">             + flate2</span><br><span class="line">             - backtrace</span><br></pre></td></tr></table></figure>

<p>我们的 Cargo.toml 变成这样，非常精简，不再需要 tokio：</p>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># in `hello-axum/Cargo.toml`</span></span><br><span class="line"></span><br><span class="line"><span class="section">[package]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;hello-axum&quot;</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line"><span class="attr">edition</span> = <span class="string">&quot;2021&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">color-eyre</span> = <span class="string">&quot;0.6.1&quot;</span></span><br><span class="line"><span class="attr">procfs</span> = <span class="string">&quot;0.12.0&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in `hello-axum/src/main.rs`</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> std::&#123;</span><br><span class="line">    process::&#123;Command, Stdio&#125;,</span><br><span class="line">    thread::sleep,</span><br><span class="line">    time::&#123;Duration, Instant&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> procfs::net::TcpState;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() <span class="punctuation">-&gt;</span> color_eyre::<span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    color_eyre::<span class="title function_ invoke__">install</span>()?;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">status</span> = Command::<span class="title function_ invoke__">new</span>(<span class="string">&quot;service&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">arg</span>(<span class="string">&quot;ssh&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">arg</span>(<span class="string">&quot;start&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">stdin</span>(Stdio::<span class="title function_ invoke__">null</span>())</span><br><span class="line">        .<span class="title function_ invoke__">stdout</span>(Stdio::<span class="title function_ invoke__">inherit</span>())</span><br><span class="line">        .<span class="title function_ invoke__">stderr</span>(Stdio::<span class="title function_ invoke__">inherit</span>())</span><br><span class="line">        .<span class="title function_ invoke__">status</span>()?;</span><br><span class="line">    <span class="built_in">assert!</span>(status.<span class="title function_ invoke__">success</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">last_activity</span> = Instant::<span class="title function_ invoke__">now</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="title function_ invoke__">count_conns</span>()? &gt; <span class="number">0</span> &#123;</span><br><span class="line">            last_activity = Instant::<span class="title function_ invoke__">now</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">idle_time</span> = last_activity.<span class="title function_ invoke__">elapsed</span>();</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;Idle for &#123;idle_time:?&#125;&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> idle_time &gt; Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">60</span>) &#123;</span><br><span class="line">                <span class="built_in">println!</span>(<span class="string">&quot;Stopping machine. Goodbye!&quot;</span>);</span><br><span class="line">                std::process::<span class="title function_ invoke__">exit</span>(<span class="number">0</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">5</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">count_conns</span>() <span class="punctuation">-&gt;</span> color_eyre::<span class="type">Result</span>&lt;<span class="type">usize</span>&gt; &#123;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(procfs::net::<span class="title function_ invoke__">tcp</span>()?</span><br><span class="line">        .<span class="title function_ invoke__">into_iter</span>()</span><br><span class="line">        <span class="comment">// don&#x27;t count listen, only established</span></span><br><span class="line">        .<span class="title function_ invoke__">filter</span>(|entry| matches!(entry.state, TcpState::Established))</span><br><span class="line">        .<span class="title function_ invoke__">filter</span>(|entry| matches!(entry.local_address.<span class="title function_ invoke__">port</span>(), <span class="number">2222</span>))</span><br><span class="line">        .<span class="title function_ invoke__">count</span>())</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们的 Dockerfile 的构建部分也很简单：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Build some code!</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> --mount=<span class="built_in">type</span>=cache,target=/app/target \</span></span><br><span class="line"><span class="language-bash">		--mount=<span class="built_in">type</span>=cache,target=/root/.cargo/registry \</span></span><br><span class="line"><span class="language-bash">		--mount=<span class="built_in">type</span>=cache,target=/root/.cargo/git \</span></span><br><span class="line"><span class="language-bash">		--mount=<span class="built_in">type</span>=cache,target=/root/.rustup \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">set</span> -eux; \</span></span><br><span class="line"><span class="language-bash">		rustup install stable; \</span></span><br><span class="line"><span class="language-bash">	 	cargo build --release; \</span></span><br><span class="line"><span class="language-bash">		objcopy --compress-debug-sections target/release/hello-axum ./hello-axum</span></span><br></pre></td></tr></table></figure>

<p>和以前一样……它有效：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ fly logs</span><br><span class="line">2022-06-20T11:06:04Z proxy[06e82219b74987] cdg [info]Machine started in 492.723163ms</span><br><span class="line">2022-06-20T11:06:04Z app[06e82219b74987] cdg [info] * Starting OpenBSD Secure Shell server sshd</span><br><span class="line">2022-06-20T11:06:04Z app[06e82219b74987] cdg [info]   ...done.</span><br><span class="line">2022-06-20T11:06:04Z app[06e82219b74987] cdg [info]Idle for 125.596µs</span><br><span class="line">2022-06-20T11:06:04Z proxy[06e82219b74987] cdg [info]Machine became reachable in 81.028264ms</span><br><span class="line">2022-06-20T11:06:14Z app[06e82219b74987] cdg [info]Idle for 5.000259697s</span><br><span class="line">2022-06-20T11:06:19Z app[06e82219b74987] cdg [info]Idle for 10.001721387s</span><br><span class="line">2022-06-20T11:06:24Z app[06e82219b74987] cdg [info]Idle for 15.002035967s</span><br><span class="line">2022-06-20T11:06:29Z app[06e82219b74987] cdg [info]Idle for 20.002387236s</span><br><span class="line">2022-06-20T11:06:34Z app[06e82219b74987] cdg [info]Idle for 25.002711273s</span><br><span class="line">2022-06-20T11:06:39Z app[06e82219b74987] cdg [info]Idle for 30.003033687s</span><br><span class="line">2022-06-20T11:06:44Z app[06e82219b74987] cdg [info]Idle for 35.003318902s</span><br><span class="line">2022-06-20T11:06:49Z app[06e82219b74987] cdg [info]Idle for 40.003605699s</span><br><span class="line">2022-06-20T11:06:54Z app[06e82219b74987] cdg [info]Idle for 45.003890203s</span><br><span class="line">2022-06-20T11:06:59Z app[06e82219b74987] cdg [info]Idle for 50.004175949s</span><br><span class="line">2022-06-20T11:07:04Z app[06e82219b74987] cdg [info]Idle for 55.004478496s</span><br><span class="line">2022-06-20T11:07:09Z app[06e82219b74987] cdg [info]Idle for 60.004781203s</span><br><span class="line">2022-06-20T11:07:09Z app[06e82219b74987] cdg [info]Stopping machine. Goodbye!</span><br></pre></td></tr></table></figure>

<pre><code>这很无聊。一切正常。
</code></pre>
<p>正确的？？然而我对此很兴奋。我很高兴知道，有了 Rust，我可以做以下任何事情：</p>
<ul>
<li>使用线程阻塞 I&#x2F;O</li>
<li>tokio 的非阻塞 I&#x2F;O</li>
<li>io-uring 与 tokio-uring</li>
<li>带 aya 的 eBPF</li>
<li>只读procfs<br>而且它们都非常无聊，工作得很好。我很乐意将它们留在生产环境中，再也不会碰它们。</li>
</ul>
<p>对我来说，这就是梦想。</p>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>fenix
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://fenixc9.github.io/remote-development-with-rust-on-fly-io/" title="【译】在 fly.io 上使用 Rust 进行远程开发">https://fenixc9.github.io/remote-development-with-rust-on-fly-io/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Rust/" rel="tag"># Rust</a>
              <a href="/tags/eBPF/" rel="tag"># eBPF</a>
              <a href="/tags/%E7%BF%BB%E8%AF%91/" rel="tag"># 翻译</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/rust-generic-associated-type/" rel="prev" title="Rust中的泛型关联类型">
      <i class="fa fa-chevron-left"></i> Rust中的泛型关联类型
    </a></div>
      <div class="post-nav-item">
    <a href="/time-wheel/" rel="next" title="如何理解和实现时间轮算法">
      如何理解和实现时间轮算法 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E6%82%A8%E5%8F%AF%E8%83%BD%E9%9C%80%E8%A6%81%E8%BF%9C%E7%A8%8B%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83"><span class="nav-number">1.</span> <span class="nav-text">为什么您可能需要远程开发环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#fly-io-%E5%88%B0%E5%BA%95%E6%98%AF%E5%B9%B2%E4%BB%80%E4%B9%88%E7%94%A8%E7%9A%84"><span class="nav-number">2.</span> <span class="nav-text">fly.io 到底是干什么用的</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SSH%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%97%AE%E9%A2%98"><span class="nav-number">3.</span> <span class="nav-text">SSH服务器问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BE%93%E5%85%A5-fly-io-%E6%9C%BA%E5%99%A8"><span class="nav-number">4.</span> <span class="nav-text">输入 fly.io 机器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%A6%E6%9C%89-tokio-%E7%9A%84%E7%AE%80%E5%8D%95-TCP-%E4%BB%A3%E7%90%86"><span class="nav-number">5.</span> <span class="nav-text">带有 tokio 的简单 TCP 代理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E4%B8%AA%E5%BE%88%E6%A3%92%E7%9A%84%E5%B8%A6%E6%9C%89-tokio-uring-%E7%9A%84-TCP-%E4%BB%A3%E7%90%86"><span class="nav-number">6.</span> <span class="nav-text">一个很棒的带有 tokio-uring 的 TCP 代理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E4%B8%AA%E5%B8%A6%E6%9C%89-aya-%E7%9A%84-eBPF-%E4%B8%9C%E8%A5%BF"><span class="nav-number">7.</span> <span class="nav-text">一个带有 aya 的 eBPF 东西</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E5%9C%B0%E8%BD%AE%E8%AF%A2-procfs"><span class="nav-number">8.</span> <span class="nav-text">简单地轮询 procfs</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="fenix"
      src="/images/a.jpeg">
  <p class="site-author-name" itemprop="name">fenix</p>
  <div class="site-description" itemprop="description">程序员，无可救药的理想主义者</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">64</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">65</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/fenixc9" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;fenixc9" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2020 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">fenix</span>
</div>

    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<link rel="stylesheet" href="https://cdn.staticfile.org/gitalk/1.8.0/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('https://cdn.staticfile.org/gitalk/1.8.0/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'd02b822b1f8e730490ab',
      clientSecret: '6e5b6fb476f3b8735a09beeb43bdbc5f160c9849',
      repo        : 'blog_comment',
      owner       : 'fenixc9',
      admin       : ['fenixc9'],
      id          : 'be9e56cffc82774d900275e953803a40',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
